<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="images/icon.png" type="image/x-icon" />
  <title>FunnelFlow – Marketing Funnel Dashboard</title>
  <!-- External fonts and icons (kept as CDN links for convenience) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <!-- Inline CSS styles -->
  <style>
    :root {
      --primary-color: #0E4954;        /* Deep teal-ocean (brand primary) */
      --primary-light: #91d8e4;       /* Luminous teal for highlights */
      --primary-dark: #000000;        /* Abyss black-blue */
      --primary-glow: 0 0 12px rgba(14, 73, 84, 0.7), 0 0 24px rgba(14, 73, 84, 0.5);
      --secondary-color: #0B1B1C;     /* Charcoal twilight (page background) */
      --accent-color: #58BCC5;        /* Glacial shimmer (accent) */
      --accent-glow: 0 0 10px rgba(88, 188, 197, 0.6), 0 0 20px rgba(88, 188, 197, 0.3);
      --gold-accent: #BBA45C;         /* Ancient bronze-gold (for eval stage) */
      --metallic-silver: #8C9AA8;     /* Worn silver, aged steel */
      --text-primary: #E0F2F1;        /* Primary text (on dark background) */
      --text-secondary: #B2DFDB;      /* Secondary text */
      --text-muted: #80CBC4;         /* Muted text */
      --success-color: #4CAF50;      /* Success (green) */
      --warning-color: #FFC107;      /* Warning (amber) */
      --error-color: #F44336;        /* Error (red) */
      --stage-awareness: #0E4954;    /* Stage color: Awareness */
      --stage-interest: #1B5E6D;     /* Stage color: Interest */
      --stage-intent: #58BCC5;       /* Stage color: Intent */
      --stage-evaluation: #BBA45C;   /* Stage color: Evaluation */
      --stage-purchase: #4CAF50;     /* Stage color: Purchase */
      --border-radius: 8px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      --transition: all 0.3s ease;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--secondary-color);
      color: var(--text-primary);
      line-height: 1.6;
      transition: var(--transition);
      padding-top: 20px; /* Prevent content under fixed header */
      overflow-x: hidden;
    }
    /* Light mode overrides */
    body.light-mode {
      --secondary-color: #FDFDFD;    /* Page background for light mode */
      --primary-dark: #FFFFFF;       /* Light background for cards and panels */
      --text-primary: #0B1B1C;       /* Primary text in light mode (dark text) */
      --text-secondary: #4a5c5d;     /* Secondary text in light mode */
      --text-muted: #788f90;         /* Muted text in light mode */
    }
    /* Global typography adjustments */
    h1, h2, h3, h4, h5, h6 {
      font-weight: 600;
    }
    p {
      margin-bottom: 0.5rem;
    }
    /* Header */
    header {
      width: 100%;
      padding: 0.5rem 1rem;
      background: var(--primary-dark);
      border-bottom: 1px solid var(--primary-color);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
    }
    .header-left h1 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent-color);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .header-left .tooltip {
      position: relative;
    }
    .header-left .tooltip .tooltiptext {
      visibility: hidden;
      background-color: var(--primary-dark);
      color: var(--text-primary);
      text-align: center;
      border-radius: var(--border-radius);
      padding: 0.5rem;
      position: absolute;
      z-index: 10;
      bottom: -60px;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      width: 240px;
      transition: opacity 0.3s;
      font-size: 0.85rem;
      border: 1px solid var(--primary-color);
    }
    .header-left .tooltip .tooltiptext::after {
      content: '';
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 6px;
      border-style: solid;
      border-color: transparent transparent var(--primary-dark) transparent;
    }
    .header-left .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    .header-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 1rem;
    }
    .header-actions {
      display: flex;
      gap: 1rem;
      margin-right: 1rem;
    }
    .action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      min-width: 100px;
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent-color), var(--primary-light));
      color: var(--secondary-color);
      transition: var(--transition);
      font-weight: 500;
      text-decoration: none;
    }
    .action-btn .fas {
      margin-right: 0.3rem;
    }
    .action-btn:hover {
      background-color: var(--primary-light);
      color: var(--text-primary);
      transform: scale(1.02);
    }
    /* Analytics summary items in header */
    .analytics-summary {
      display: flex;
      gap: 1.5rem;
      background-color: var(--primary-dark);
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      border: 1px solid var(--primary-color);
    }
    .analytics-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .analytics-item span:first-child {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .analytics-item span:last-child {
      font-weight: 600;
      font-size: 1rem;
      color: var(--accent-color);
    }
    /* Main layout */
    .main-content {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      padding: 3.5rem 1rem 2rem; /* top padding accounts for fixed header */
    }
    .funnel-sidebar, .leads-management {
      flex: 1;
      min-width: 300px;
      background-color: var(--primary-dark);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      border: 1px solid var(--primary-color);
      overflow: auto;
    }
    /* Funnel stages */
    .funnel-container {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      padding-bottom: 1rem;
    }
    .funnel-stage {
      flex: 1;
      min-width: 200px;
      background: var(--primary-dark);
      border-radius: var(--border-radius);
      overflow: hidden;
      color: white;
      text-align: center;
      padding: 0;
      display: flex;
      flex-direction: column;
      max-height: 500px;
    }
    .stage-header {
      padding: 0.5rem;
      font-weight: 600;
      position: relative;
    }
    .stage-header.clickable {
      cursor: pointer;
    }
    .stage-header.clickable:hover {
      background-color: rgba(255,255,255,0.1);
    }
    .stage-body {
      flex: 1;
      padding: 0.5rem;
      overflow-y: auto;
    }
    .stage-awareness { background: linear-gradient(135deg, var(--stage-awareness) 0%, #1B5E6D 100%); }
    .stage-interest { background: linear-gradient(135deg, var(--stage-interest) 0%, #2A7D8C 100%); }
    .stage-intent { background: linear-gradient(135deg, var(--stage-intent) 0%, #7CD6DD 100%); }
    .stage-evaluation { background: linear-gradient(135deg, var(--stage-evaluation) 0%, #CEB772 100%); }
    .stage-purchase { background: linear-gradient(135deg, var(--stage-purchase) 0%, #8BC34A 100%); }
    .stage-header .count {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 0.9rem;
    }
    .empty {
      font-style: italic;
      color: var(--text-muted);
      text-align: center;
      margin-top: 1rem;
    }
    .lead-card {
      background-color: var(--primary-color);
      color: var(--text-primary);
      padding: 0.5rem;
      border-radius: var(--border-radius);
      margin-bottom: 0.5rem;
      cursor: pointer;
      user-select: none;
    }
    .lead-card .company {
      font-weight: 600;
    }
    .lead-card .contact {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    .tags-wrapper .tag {
      display: inline-block;
      background: var(--accent-color);
      color: var(--secondary-color);
      border-radius: 4px;
      padding: 0.1rem 0.4rem;
      font-size: 0.7rem;
    }
    /* Content badges in funnel stages */
    .content-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 0.5rem;
    }
    .content-badge {
      background: var(--primary-dark);
      border: 1px solid var(--accent-color);
      color: var(--accent-color);
      padding: 2px 4px;
      font-size: 0.75rem;
      border-radius: 4px;
      cursor: grab;
    }
    .content-badge:hover {
      background: var(--primary-color);
      color: var(--text-primary);
    }
    .content-badge i {
      margin-right: 2px;
    }
    /* Table of leads */
    .leads-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    .leads-table th, .leads-table td {
      border: 1px solid var(--primary-color);
      padding: 0.5rem;
      text-align: left;
      font-size: 0.9rem;
      vertical-align: middle;
    }
    .leads-table th {
      background-color: var(--primary-color);
      color: var(--text-primary);
      position: sticky;
      top: 0;
      z-index: 5;
    }
    .leads-table tbody tr:hover {
      background-color: rgba(255,255,255,0.05);
      cursor: pointer;
    }
    .leads-table .actions {
      text-align: center;
    }
    .leads-table .actions button {
      margin: 0 2px;
    }
    /* Analytics details section */
    .analytics-details {
      margin-top: 1rem;
    }
    .analytics-details h3 {
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .analytics-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .analytics-card {
      background: var(--primary-dark);
      border: 1px solid var(--primary-color);
      border-radius: var(--border-radius);
      padding: 1rem;
      flex: 1 1 150px;
      min-width: 120px;
      text-align: center;
    }
    .analytics-card h4 {
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
      color: var(--accent-color);
    }
    .analytics-card p {
      font-size: 1.1rem;
      font-weight: 600;
    }
    /* Section headers and guides */
    .section-header h2 {
      font-size: 1.2rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .lead-management-guide, .content-management-guide {
      background-color: var(--primary-dark);
      border-radius: var(--border-radius);
      padding: 1rem;
      margin: 1rem 0;
      border-left: 4px solid var(--accent-color);
    }
    .lead-management-guide h3, .content-management-guide h3 {
      color: var(--accent-color);
      margin-bottom: 0.5rem;
    }
    .lead-management-guide ul, .content-management-guide ul {
      padding-left: 1rem;
      margin-top: 0.5rem;
    }
    .lead-management-guide li, .content-management-guide li {
      line-height: 1.6;
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
    }
    /* Modal styles */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .modal.hidden { display: none; }
    .modal-content {
      background: var(--primary-dark);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 500px;
      position: relative;
      border: 1px solid var(--primary-color);
    }
    .modal-content h2 {
      margin-bottom: 1rem;
      color: var(--accent-color);
      font-size: 1.25rem;
    }
    .close-modal {
      position: absolute;
      top: 0.5rem;
      right: 0.75rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-primary);
      cursor: pointer;
    }
    .close-modal:hover {
      color: var(--error-color);
    }
    form {
      width: 100%;
    }
    .form-columns {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .form-group {
      flex: 1 1 45%;
      display: flex;
      flex-direction: column;
      margin-bottom: 0.75rem;
    }
    .form-group.full-width {
      flex: 1 1 100%;
    }
    .form-group label {
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
      color: var(--text-secondary);
    }
    .form-group input, .form-group select, .form-group textarea {
      padding: 0.5rem;
      border: 1px solid var(--primary-color);
      border-radius: var(--border-radius);
      background: var(--primary-dark);
      color: var(--text-primary);
      font-size: 0.95rem;
      font-family: 'Inter', sans-serif;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(88, 188, 197, 0.3);
    }
    .form-group textarea {
      resize: vertical;
    }
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .submit-btn, .cancel-btn, .delete-btn {
      padding: 0.6rem 1.2rem;
      border-radius: var(--border-radius);
      font-size: 0.95rem;
      border: none;
      cursor: pointer;
    }
    .submit-btn {
      background-color: var(--accent-color);
      color: var(--secondary-color);
      font-weight: 600;
    }
    .submit-btn:hover {
      background-color: #71d0d9;
    }
    .cancel-btn {
      background-color: #aaa;
      color: #000;
    }
    .cancel-btn:hover {
      background-color: #888;
    }
    .delete-btn {
      background-color: var(--error-color);
      color: var(--text-primary);
    }
    .delete-btn:hover {
      background-color: #ff5252;
    }
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--success-color);
      color: #fff;
      padding: 0.8rem 1.2rem;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      transform: translateY(100px);
      opacity: 0;
      transition: var(--transition);
      z-index: 1100;
      font-size: 0.95rem;
    }
    .toast.error {
      background-color: var(--error-color);
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    /* Onboarding overlay & tooltips */
    .onboarding-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 2rem;
      z-index: 3000;
    }
    .onboarding-overlay.hidden { display: none; }
    .onboarding-content {
      max-width: 600px;
    }
    .onboarding-content h2 {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: var(--accent-color);
    }
    .onboarding-steps {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      text-align: left;
      margin-bottom: 2rem;
    }
    .onboarding-step {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }
    .onboarding-step i {
      font-size: 1.5rem;
      color: var(--accent-color);
      flex-shrink: 0;
    }
    .onboarding-step h4 {
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
      color: var(--accent-color);
    }
    .onboarding-step p {
      font-size: 0.9rem;
      color: var(--text-primary);
      line-height: 1.4;
    }
    .onboarding-actions {
      margin-top: 1rem;
    }
    .onboarding-actions button {
      margin: 0 0.5rem;
    }
    .onboarding-tooltip {
      background-color: var(--primary-light);
      color: var(--primary-dark);
      padding: 1rem;
      border-radius: 10px;
      width: 220px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 4000;
      font-size: 0.95rem;
      position: absolute;
      transition: all 0.3s ease-in-out;
      animation: floatIn 0.3s ease-out;
    }
    .onboarding-tooltip:after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: var(--accent-color) transparent transparent transparent;
    }
    /* Pulse highlight animation */
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: none; }
      50% { transform: scale(1.05); box-shadow: var(--accent-glow); }
      100% { transform: scale(1); box-shadow: none; }
    }
    .pulse-highlight {
      animation: pulse 2s infinite;
    }
    /* Additional subtle animations */
    @keyframes floatIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="header-left">
      <h1>FunnelFlow 
        <span class="tooltip">
          <i class="fas fa-info-circle" style="color: var(--text-muted); font-size: 1rem;"></i>
          <span class="tooltiptext">Drag &amp; drop leads through your marketing funnel. Track conversions and optimize your content strategy.</span>
        </span>
      </h1>
    </div>
    <div class="header-right">
      <div class="header-actions">
        <button id="add-lead-btn" class="action-btn tooltip pulse-on-hover" type="button">
          <i class="fas fa-plus"></i> Add Lead
          <span class="tooltiptext">Add a new lead to your funnel</span>
        </button>
        <button id="add-content-btn" class="action-btn tooltip pulse-on-hover" type="button">
          <i class="fas fa-file-alt"></i> Add Content
          <span class="tooltiptext">Add a new content strategy</span>
        </button>
        <button id="install-btn" class="action-btn tooltip" style="display:none;" type="button">
          <i class="fas fa-download"></i> Install App
          <span class="tooltiptext">Install this app on your device</span>
        </button>
        <button id="export-pdf" class="action-btn tooltip" type="button">
          <i class="fas fa-file-pdf"></i> Export PDF
          <span class="tooltiptext">Export funnel report as PDF</span>
        </button>
        <button id="export-excel" class="action-btn tooltip" type="button">
          <i class="fas fa-file-excel"></i> Export Excel
          <span class="tooltiptext">Export all leads to Excel</span>
        </button>
      </div>
      <!-- Theme toggle button -->
      <button id="theme-toggle" class="action-btn tooltip" type="button" title="Toggle Dark/Light Mode">
        <i class="fas fa-sun"></i>
      </button>
      <!-- Analytics summary in header -->
      <div class="analytics-summary">
        <div class="analytics-item tooltip">
          <span>Total Leads</span>
          <span id="total-leads">0</span>
          <span class="tooltiptext">Total leads in your funnel</span>
        </div>
        <div class="analytics-item tooltip">
          <span>Awareness→Interest</span>
          <span id="awareness-interest-rate">0%</span>
          <span class="tooltiptext">Conversion rate from Awareness to Interest</span>
        </div>
        <div class="analytics-item tooltip">
          <span>Interest→Consideration</span>
          <span id="interest-consideration-rate">0%</span>
          <span class="tooltiptext">Conversion rate from Interest to Consideration</span>
        </div>
        <div class="analytics-item tooltip">
          <span>Conversion Rate</span>
          <span id="conversion-rate">0%</span>
          <span class="tooltiptext">Overall funnel conversion rate</span>
        </div>
      </div>
    </div>
  </header>
  
  <!-- Main content area -->
  <main class="main-content">
    <!-- Left: Funnel visualization -->
    <div class="funnel-sidebar">
      <!-- Smart Insights at top of funnel column -->
      <div id="smart-advice-box" class="smart-advice-box">
        <h3><i class="fas fa-robot"></i> Smart Funnel Insights</h3>
        <div id="funnel-advice"><!-- Advice list inserted by JS --></div>
      </div>
      <!-- Funnel stages container -->
      <div class="funnel-container">
        <!-- Awareness Stage -->
        <div class="funnel-stage stage-awareness interactive-element">
          <div class="stage-header">Awareness <span id="awareness-count" class="count">0</span></div>
          <div class="stage-body" data-drop-target="awareness"></div>
        </div>
        <!-- Interest Stage -->
        <div class="funnel-stage stage-interest interactive-element">
          <div class="stage-header">Interest <span id="interest-count" class="count">0</span></div>
          <div class="stage-body" data-drop-target="interest"></div>
        </div>
        <!-- Consideration Stage (Intent+Evaluation+Purchase grouped) -->
        <div class="funnel-stage stage-intent interactive-element">
          <div class="stage-header clickable" onclick="window.location='#lead-table-section';">Consideration <span id="consideration-count" class="count">0</span></div>
          <div class="stage-body" data-drop-target="intent"></div>
        </div>
        <!-- Evaluation Stage (invisibly part of Consideration count) -->
        <div class="funnel-stage stage-evaluation interactive-element" style="display:none;">
          <div class="stage-header">Evaluation</div>
          <div class="stage-body" data-drop-target="evaluation"></div>
        </div>
        <!-- Purchase Stage (also part of Consideration count) -->
        <div class="funnel-stage stage-purchase interactive-element" style="display:none;">
          <div class="stage-header">Purchase</div>
          <div class="stage-body" data-drop-target="purchase"></div>
        </div>
      </div>
    </div>
    
    <!-- Right: Lead management and content management -->
    <div class="leads-management">
      <!-- Lead Management Section -->
      <div class="section-header">
        <h2><i class="fas fa-users" id="leadmanagement"></i> Lead Management</h2>
      </div>
      <div class="lead-management-guide">
        <h3>Lead Management Guide</h3>
        <ul>
          <li><strong>Add Leads:</strong> Click "Add Lead" to create new leads</li>
          <li><strong>Edit Leads:</strong> Click a lead row or the edit icon to modify</li>
          <li><strong>Delete Leads:</strong> Remove unwanted leads using the delete button</li>
          <li><strong>View All Leads:</strong> Browse all leads in the table below</li>
        </ul>
      </div>
      <div id="lead-table-section">
        <table class="leads-table">
          <thead>
            <tr>
              <th>Company</th>
              <th>Contact</th>
              <th>Stage</th>
              <th>Content Used</th>
              <th>Last Contact</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="leads-table-body">
            <tr><td colspan="6" style="text-align:center;">No leads found</td></tr>
          </tbody>
        </table>
      </div>
      <!-- Advanced Analytics Section -->
      <div class="analytics-details">
        <h3><i class="fas fa-chart-line"></i> Advanced Analytics</h3>
        <div class="analytics-grid">
          <div class="analytics-card">
            <h4>Avg. Time in Funnel</h4>
            <p id="avg-funnel-time">0 days</p>
          </div>
          <div class="analytics-card">
            <h4>Hot Leads</h4>
            <p id="hot-leads-count">0</p>
          </div>
          <div class="analytics-card">
            <h4>Content Effectiveness</h4>
            <p id="content-effectiveness">0%</p>
          </div>
          <div class="analytics-card">
            <h4>Engagement Rate</h4>
            <p id="engagement-rate">0%</p>
          </div>
          <div class="analytics-card">
            <h4>Response Time</h4>
            <p id="response-time">0 hrs</p>
          </div>
          <div class="analytics-card">
            <h4>Revenue Potential</h4>
            <p id="revenue-potential">$0</p>
          </div>
        </div>
      </div>
      <!-- Content Management Section -->
      <div class="section-header" style="margin-top: 2rem;">
        <h2><i class="fas fa-file-alt"></i> Content Strategies</h2>
      </div>
      <div class="content-management-guide">
        <h3>Content Management Guide</h3>
        <ul>
          <li><strong>Add New Content:</strong> Click "Add Content" to create marketing assets</li>
          <li><strong>Edit Content:</strong> Click on any content item to modify it</li>
          <li><strong>Delete Content:</strong> Remove outdated content using the delete button</li>
          <li><strong>View All Content:</strong> Browse all content strategies below</li>
          <li><strong>Assign Content:</strong> Link content to leads to track effectiveness</li>
        </ul>
      </div>
      <div id="content-items-container" class="content-items-container"><!-- Content items appended here --></div>
    </div>
  </main>
  
  <!-- Add Lead Modal -->
  <div id="add-lead-modal" class="modal hidden">
    <div class="modal-content">
      <button class="close-modal" type="button">&times;</button>
      <h2>Add New Lead</h2>
      <form id="lead-form">
        <div class="form-columns">
          <div class="form-group">
            <label for="lead-company">Company Name</label>
            <input type="text" id="lead-company" />
          </div>
          <div class="form-group">
            <label for="lead-contact">Contact Person</label>
            <input type="text" id="lead-contact" />
          </div>
          <div class="form-group">
            <label for="lead-email">Email</label>
            <input type="email" id="lead-email" />
          </div>
          <div class="form-group">
            <label for="lead-phone">Phone</label>
            <input type="tel" id="lead-phone" />
          </div>
          <div class="form-group">
            <label for="lead-stage">Initial Stage</label>
            <select id="lead-stage">
              <option value="awareness">Awareness</option>
              <option value="interest">Interest</option>
              <option value="intent">Intent</option>
              <option value="evaluation">Evaluation</option>
              <option value="purchase">Purchase</option>
            </select>
          </div>
          <div class="form-group">
            <label for="lead-source">Source</label>
            <select id="lead-source">
              <option value="website">Website</option>
              <option value="social">Social Media</option>
              <option value="referral">Referral</option>
              <option value="event">Event</option>
              <option value="ad">Advertisement</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="lead-industry">Industry</label>
            <select id="lead-industry">
              <option value="saas">SaaS</option>
              <option value="ecommerce">E-commerce</option>
              <option value="healthcare">Healthcare</option>
              <option value="realestate">Real Estate</option>
              <option value="education">Education</option>
              <option value="consulting">Consulting</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="lead-status">Status</label>
            <select id="lead-status">
              <option value="new">New</option>
              <option value="hot">Hot</option>
              <option value="cold">Cold</option>
              <option value="stalled">Stalled</option>
            </select>
          </div>
        </div>
        <div class="form-group full-width">
          <label for="lead-content">Content Strategy</label>
          <select id="lead-content" class="content-select" multiple><!-- Options populated by JS --></select>
        </div>
        <div class="form-group full-width">
          <label for="lead-notes">Notes</label>
          <textarea id="lead-notes" rows="3"></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="cancel-btn">Cancel</button>
          <button type="submit" class="submit-btn">Add Lead</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Add Content Modal -->
  <div id="add-content-modal" class="modal hidden">
    <div class="modal-content">
      <button class="close-modal" type="button">&times;</button>
      <h2>Add Content Strategy</h2>
      <form id="content-form">
        <div class="form-group">
          <label for="content-name">Content Name</label>
          <input type="text" id="content-name" />
        </div>
        <div class="form-group">
          <label for="content-description">Description</label>
          <textarea id="content-description" rows="2"></textarea>
        </div>
        <div class="form-columns">
          <div class="form-group">
            <label for="content-stage">Funnel Stage</label>
            <select id="content-stage">
              <option value="awareness">Awareness</option>
              <option value="interest">Interest</option>
              <option value="intent">Intent</option>
              <option value="evaluation">Evaluation</option>
              <option value="purchase">Purchase</option>
            </select>
          </div>
          <div class="form-group">
            <label for="content-type">Content Type</label>
            <select id="content-type">
              <option value="blog">Blog Post</option>
              <option value="ebook">E-book</option>
              <option value="video">Video</option>
              <option value="webinar">Webinar</option>
              <option value="casestudy">Case Study</option>
              <option value="demo">Demo</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="content-link">Link (URL)</label>
            <input type="url" id="content-link" />
          </div>
          <div class="form-group">
            <label for="content-target-conversion">Target Conversion Rate (%)</label>
            <input type="number" id="content-target-conversion" min="0" max="100" step="1" />
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="cancel-btn">Cancel</button>
          <button type="submit" class="submit-btn">Save Content</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Edit Lead Modal -->
  <div id="edit-lead-modal" class="modal hidden">
    <div class="modal-content">
      <button class="close-modal" type="button">&times;</button>
      <h2>Edit Lead</h2>
      <form id="edit-lead-form">
        <input type="hidden" id="edit-lead-id" />
        <div class="form-columns">
          <div class="form-group">
            <label for="edit-lead-company">Company Name</label>
            <input type="text" id="edit-lead-company" />
          </div>
          <div class="form-group">
            <label for="edit-lead-contact">Contact Person</label>
            <input type="text" id="edit-lead-contact" />
          </div>
          <div class="form-group">
            <label for="edit-lead-email">Email</label>
            <input type="email" id="edit-lead-email" />
          </div>
          <div class="form-group">
            <label for="edit-lead-phone">Phone</label>
            <input type="tel" id="edit-lead-phone" />
          </div>
          <div class="form-group">
            <label for="edit-lead-stage">Current Stage</label>
            <select id="edit-lead-stage">
              <option value="awareness">Awareness</option>
              <option value="interest">Interest</option>
              <option value="intent">Intent</option>
              <option value="evaluation">Evaluation</option>
              <option value="purchase">Purchase</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-lead-source">Source</label>
            <select id="edit-lead-source">
              <option value="website">Website</option>
              <option value="social">Social Media</option>
              <option value="referral">Referral</option>
              <option value="event">Event</option>
              <option value="ad">Advertisement</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-lead-industry">Industry</label>
            <select id="edit-lead-industry">
              <option value="saas">SaaS</option>
              <option value="ecommerce">E-commerce</option>
              <option value="healthcare">Healthcare</option>
              <option value="realestate">Real Estate</option>
              <option value="education">Education</option>
              <option value="consulting">Consulting</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-lead-status">Status</label>
            <select id="edit-lead-status">
              <option value="new">New</option>
              <option value="hot">Hot</option>
              <option value="cold">Cold</option>
              <option value="stalled">Stalled</option>
            </select>
          </div>
        </div>
        <div class="form-group full-width">
          <label for="edit-lead-content">Content Strategy</label>
          <select id="edit-lead-content" class="content-select" multiple><!-- Options populated by JS --></select>
        </div>
        <div class="form-group full-width">
          <label for="edit-lead-notes">Notes</label>
          <textarea id="edit-lead-notes" rows="3"></textarea>
        </div>
        <div class="form-actions">
          <button type="button" id="delete-lead-btn" class="delete-btn">Delete Lead</button>
          <button type="submit" class="submit-btn">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Edit Content Modal -->
  <div id="edit-content-modal" class="modal hidden">
    <div class="modal-content">
      <button class="close-modal" type="button">&times;</button>
      <h2>Edit Content Strategy</h2>
      <form id="edit-content-form">
        <input type="hidden" id="edit-content-id" />
        <div class="form-group">
          <label for="edit-content-name">Content Name</label>
          <input type="text" id="edit-content-name" />
        </div>
        <div class="form-group">
          <label for="edit-content-description">Description</label>
          <textarea id="edit-content-description" rows="2"></textarea>
        </div>
        <div class="form-columns">
          <div class="form-group">
            <label for="edit-content-stage">Funnel Stage</label>
            <select id="edit-content-stage">
              <option value="awareness">Awareness</option>
              <option value="interest">Interest</option>
              <option value="intent">Intent</option>
              <option value="evaluation">Evaluation</option>
              <option value="purchase">Purchase</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-content-type">Content Type</label>
            <select id="edit-content-type">
              <option value="blog">Blog Post</option>
              <option value="ebook">E-book</option>
              <option value="video">Video</option>
              <option value="webinar">Webinar</option>
              <option value="casestudy">Case Study</option>
              <option value="demo">Demo</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-content-link">Link (URL)</label>
            <input type="url" id="edit-content-link" />
          </div>
          <div class="form-group">
            <label for="edit-content-target-conversion">Target Conversion Rate (%)</label>
            <input type="number" id="edit-content-target-conversion" min="0" max="100" step="1" />
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="cancel-btn">Cancel</button>
          <button type="submit" class="submit-btn">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>
  
  <!-- Onboarding Overlay -->
  <div id="onboarding-overlay" class="onboarding-overlay hidden">
    <div class="onboarding-content">
      <h2>Welcome to FunnelFlow</h2>
      <p>Let's get you started with your marketing funnel management!</p>
      <div class="onboarding-steps">
        <div class="onboarding-step">
          <i class="fas fa-plus-circle"></i>
          <div>
            <h4>Add Leads</h4>
            <p>Start by adding leads to your funnel. Click the "Add Lead" button to create new leads.</p>
          </div>
        </div>
        <div class="onboarding-step">
          <i class="fas fa-file-alt"></i>
          <div>
            <h4>Add Content</h4>
            <p>Create content strategies to nurture leads. Use "Add Content" to add assets like blog posts or webinars.</p>
          </div>
        </div>
        <div class="onboarding-step">
          <i class="fas fa-exchange-alt"></i>
          <div>
            <h4>Drag &amp; Drop</h4>
            <p>Move leads between stages by dragging them to track their progress through the funnel.</p>
          </div>
        </div>
        <div class="onboarding-step">
          <i class="fas fa-chart-line"></i>
          <div>
            <h4>Track Analytics</h4>
            <p>Monitor conversion rates and get smart insights to optimize your funnel performance.</p>
          </div>
        </div>
      </div>
      <div class="onboarding-actions">
        <button id="skip-onboarding" class="cancel-btn">Skip Tutorial</button>
        <button id="start-using-app" class="submit-btn">Get Started</button>
      </div>
    </div>
  </div>
  
  <!-- JavaScript Libraries (embedded) -->
  <script>
    /*! jQuery v3.6.0 | (c) OpenJS Foundation and other contributors | jquery.org/license */
    !function(e,t){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(C,e){"use strict";var t=[],E=Object.getPrototypeOf,n=t.slice,g=t.flat?function(e){return t.flat.call(e)}:function(e){return t.concat.apply([],e)},u=t.push,i=t.indexOf,o={},A=o.toString,v=o.hasOwnProperty,s=v.toString,l=s.call(Object),y={},r=function(e){return"function"==typeof e&&"number"!=typeof e.nodeType&&"function"!=typeof e.item},D=function(e){return null!=e&&e===e.window},c=C.document,h={type:!0,src:!0,nonce:!0,noModule:!0};function d(e,t,i){var n,o,a=(i=i||c).createElement("script");if(a.text=e,t)for(n in h)(o=t[n]||t.getAttribute&&t.getAttribute(n))&&a.setAttribute(n,o);i.head.appendChild(a).parentNode.removeChild(a)}function p(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?o[A.call(e)]||"object":typeof e}var f="3.6.0",S=function(e,t){return new S.fn.init(e,t)};function x(e){var t=!!e&&"length"in e&&e.length,i=p(e);return!r(e)&&!D(e)&&("array"===i||0===t||"number"==typeof t&&0<t&&t-1 in e)}S.fn=S.prototype={jquery:f,constructor:S,length:0,toArray:function(){return n.call(this)},get:function(e){return null==e?n.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=S.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return S.each(this,e)},map:function(n){return this.pushStack(S.map(this,function(e,t){return n.call(e,t,e)}))},slice:function(){return this.pushStack(n.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},even:function(){return this.pushStack(S.grep(this,function(e,t){return(t+1)%2}))},odd:function(){return this.pushStack(S.grep(this,function(e,t){return t%2}))},eq:function(e){var t=this.length,i=+e+(e<0?t:0);return this.pushStack(i>=0&&i<t?[this[i]]:[])},end:function(){return this.prevObject||this.constructor()},push:u,sort:t.sort,splice:t.splice},S.extend=S.fn.extend=function(){var e,t,i,n,o,a,r=arguments[0]||{},s=1,l=arguments.length,u=!1;for("boolean"==typeof r&&(u=r,r=arguments[s]||{},s++),"object"==typeof r||rance with if(n=r[r>1?].he:))p(s<if ackIngthin||(s. men[[n=r[r>0point],setti-1:
    // ... (jQuery minified content continues)
    /* (For brevity, the rest of the jQuery 3.6.0 minified code would be included here) */
  </script>
  <script>
    /*! Chart.js (embedded for completeness, though not actively used in current code) */
    !function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Chart=e()}(this,function(){"use strict";/* ... Chart.js minified code ... */});
    /* (Full Chart.js minified code would be here if needed) */
  </script>
  <script>
    /*! jsPDF 2.5.1 (for PDF export) */
    var jspdf;(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory():typeof define==="function"&&define.amd?define(factory):(global=typeof globalThis!=="undefined"?globalThis:global||self,global.jspdf=factory());})(this,function(){/* ... jsPDF UMD minified code ... */});
    /* (Complete jsPDF code goes here) */
  </script>
  <script>
    /*! Select2 4.1.0-rc.0 (jQuery select enhancement) */
    /* Select2 will attach to .content-select elements */
    !function(n){"function"==typeof define&&define.amd?define(["jquery"],n):"object"==typeof module&&module.exports?module.exports=function(e,t){return void 0===t&&(t="undefined"!=typeof window?require("jquery"):require("jquery")(e)),n(t),t}:n(jQuery)}(function(S){/* ... select2 minified code ... */});
    /* (Full select2 minified script would be embedded here) */
  </script>
  <script>
    /*! Dragula 3.7.3 (for drag-and-drop) */
    !function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;(t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).dragula=e()}}(function(){return function e(t,n,o){function r(a,u){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!u&&c)return c(a,!0);if(i)return i(a,!0);var l=new Error("Cannot find module '"+a+"'");throw l.code="MODULE_NOT_FOUND",l}var s=n[a]={exports:{}};t[a][0].call(s.exports,function(e){return r(t[a][1][e]||e)},s,s.exports,e,t,n,o)}return n[a].exports}for(var i="function"==typeof require&&require,a=0;a<o.length;a++)r(o[a]);return r}({1:[function(e,t,n){"use strict";function o(e){var t=r[e];return t?t.lastIndex=0:r[e]=t=new RegExp(i+e+f,"g"),t}function r(e,t){var n=e.className;n.length?o(t).test(n)||(e.className+=" "+t):e.className=t}function i(e,t){e.className=e.className.replace(o(t)," ").trim()}var r={},i="(?:^|\\s)",f="(?:\\s|$)";t.exports={add:r,rm:i}},{}],2:[function(e,t,n){(function(t){"use strict";function n(e,t){function n(e){return-1!==L.containers.indexOf(e)||R.isContainer(e)}function a(e){var t=e?"remove":"add";A(X,t,"mousedown",O),A(X,t,"mouseup",Y)}function u(e){var t=e?"remove":"add";A(X,t,"mousemove",j)}function c(e){var t=e?"remove":"add";J[t](X,"selectstart",N),J[t](X,"click",N)}function d(){a(!0),Y({})}function N(e){Z&&e.preventDefault()}function O(e){Q=e.clientX,$=e.clientY;var t=1!==b(e)||e.metaKey||e.ctrlKey;if(!t){var o=e.target,r=T(o);r&&(Z=r,u(),"mousedown"===e.type&&(k(o)?o.focus():e.preventDefault()))}}function j(e){if(Z){if(0===b(e))return void Y({});if(void 0===e.clientX||e.clientX!==Q||void 0===e.clientY||e.clientY!==$){if(R.ignoreInputTextSelection){var t=x("clientX",e),n=x("clientY",e),o=D.elementFromPoint(t,n);if(k(o))return}var r=Z;u(!0),c(),G(),_(r);var i=I(tt);z=x("pageX",e)-i.left,et=x("pageY",e)-i.top,E.add(it||tt,"gu-transit"),at(),st(e)}}}}function T(e){if(!(L.dragging&&ot||n(e))){for(var t=e;P(e)&&n(P(e))===!1;){if(R.invalid(e,t))return;if(e=P(e),!e)return}var o=P(e);if(o&&!R.invalid(e,t)){var r=R.moves(e,o,t,M(e));if(r)return{item:e,source:o}}}}function q(e){return!!T(e)}function B(e){var t=T(e);t&&_(t)}function _(t){W(t.item,t.source)&&(it=t.item.cloneNode(!0),L.emit("cloned",it,t.item,"copy")),ot=t.source,tt=t.item,nt=et=M(t.item),L.dragging=!0,L.emit("drag",tt,ot)}function at(){return!1}function G(){if(L.dragging){var e=it||tt;H(e,P(e))}}function ut(){Z=!1,u(!0),c(!0)}function Y(e){if(ut(),L.dragging){var t=it||tt,n=x("clientX",e),o=x("clientY",e),r=i(Q,n,o),a=J(r,n,o);a&&(it&&R.copySortSource||!it||a!==ot)?H(t,a):R.removeOnSpill?nt():ct()}}function H(e,t){var n=P(e);it&&R.copySortSource&&t===ot&&n.removeChild(tt),L.emit("drop",e,t,ot,et),lt()}function nt(){if(L.dragging){var e=it||tt,t=P(e);t&&t.removeChild(e),L.emit(it?"cancel":"remove",e,t,ot),lt()}}function ct(t){if(L.dragging){var n=arguments.length>0?t:R.revertOnSpill,o=it||tt,r=P(o),i=!1===rt(r);!1!==n&&i&&ot.appendChild(o),i&&L.emit("cancel",o,ot,ot),lt()}}function lt(){var e=it||tt,t=P(e);e&&t&&E.rm(e,"gu-transit"),it&&ot&&P(tt)&&ot.removeChild(tt),L.dragging=!1,Z=!1,tt=null,it=null,ot=null,Q=void 0,$=void 0,E.rm(X,"gu-unselectable"),L.emit("dragend",e),ot&&L.emit("out",e,ot,ot)}function st(e){L.dragging&&L.emit("shadow",tt,ot,e)}function ft(e,t,n){return function(o){var r=T(o);r&&(L.emit(e,r.item,tn,r.source),t&&t())}}var dt=e||{},nt=dt.moves||ht,ct=dt.copy||at,lt=dt.accepts||pt,ft=dt.invalid||vt,gt=dt.containers||[],mt=dt.isContainer||_t,yt=dt.copySortSource||!1,bt=dt.revertOnSpill||!1,wt=dt.removeOnSpill||!1,Ct=dt.direction||"vertical",Lt=dt.ignoreInputTextSelection||!1,kt=a,Et=ut,St=Y,Tt=B,Ct=q,zt=_;if(!(gt.indexOf||dt.container))throw new Error("This environment does not support Array.prototype.indexOf");if(gt=gt||[],gt.forEach(function(e){e=f(e)}),dt.containers=gt,mt&&(gt=gt.concat([document.body])),!0===yt||!1===yt?dt.copySortSource=yt:dt.copySortSource=!1,!0===wt||!1===wt?dt.removeOnSpill=wt:dt.removeOnSpill=!1,!0===bt||!1===bt?dt.revertOnSpill=bt:dt.revertOnSpill=!1,"horizontal"!==Ct&&"vertical"!==Ct)throw new Error("Invalid direction: "+Ct);var It,Ai=It?"touchstart":"mousedown",Ni=It?"touchmove":"mousemove",Oi=It?"touchend":"mouseup",ji=It?"touchcancel":"mouseleave",Ri=x.getCurrentScreen;It="ontouchstart"in window||navigator.maxTouchPoints;var Z=!1,V=document,Zt=!1,tt=null,it=null,ot=null,et=null,tt=null,nt=gt.filter(function(e){return n(e)}),at=document.body,ut=ft,ct=ft,lt=(ut=ft).dragula=Et;return ut.containers=nt,ut.dragging=!1,It&&I(V,"touchstart",O),I(V,"mousedown",O),I(V,"mousemove",j),I(V,"mouseup",Y),I(V,"contextmenu",C),ut;var Pn,Zt=Ni,Vt=ji;function I(e,t,n){A(e,"add",t,n)}function A(e,t,n,o){var r=e[t+"EventListener"].bind(e);["add","remove"].indexOf(t)>-1?r(n,o):r()}function O(e){if(Z=Z||!0,"touchmove"===e.type&&(e=e.changedTouches[0]),!L.dragging){Z&&Q(L);var t=e.target,n=T(t);if(n&&t&&t.nodeName){var o="gu-".concat(t.nodeName.toLowerCase());J.add(t,o)}}}}}});/* truncated for brevity */
    /* (Full Dragula minified code goes here) */
  </script>
  <script>
    /*! SheetJS (XLSX 0.19.3 for Excel export) */
    /* The XLSX library is used for exporting to Excel */
    !function(){/* sheetjs xlsx.full.min.js code here */}();
    /* (Full SheetJS library code would be embedded here) */
  </script>
  
  <!-- Main Application Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Apply saved theme preference on load
      const savedTheme = localStorage.getItem('theme');
      if(savedTheme === 'light') {
        document.body.classList.add('light-mode');
        document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-moon"></i>';
      } else {
        document.body.classList.remove('light-mode');
        document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-sun"></i>';
      }
      // Authentication check (simple PIN-based auth)
      const isAuthenticated = localStorage.getItem('authenticated') === 'true';
      if (isAuthenticated) {
        document.getElementById('auth-screen')?.classList.add('hidden');
        document.getElementById('app-container')?.classList.remove('hidden');
        setupInstallButton();
        // Show onboarding overlay if not completed before
        if (!localStorage.getItem('onboarding_completed')) {
          document.getElementById('onboarding-overlay').classList.remove('hidden');
          setupOnboarding();
        } else {
          initializeApp();
        }
      } else {
        setupAuth();
      }
    });
    
    // Toggle theme event
    document.getElementById('theme-toggle').addEventListener('click', () => {
      const body = document.body;
      const toggleBtn = document.getElementById('theme-toggle');
      if (body.classList.contains('light-mode')) {
        body.classList.remove('light-mode');
        toggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
        localStorage.setItem('theme', 'dark');
      } else {
        body.classList.add('light-mode');
        toggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
        localStorage.setItem('theme', 'light');
      }
    });
    
    // Authentication setup (simple PIN login)
    function setupAuth() {
      const pinInput = document.getElementById('pin-input');
      const loginBtn = document.getElementById('login-btn');
      const pinError = document.getElementById('pin-error');
      const validPins = ['1234','4321','0000'];
      pinInput.focus();
      loginBtn.addEventListener('click', function() {
        if (validPins.includes(pinInput.value)) {
          localStorage.setItem('authenticated', 'true');
          document.getElementById('auth-screen').classList.add('hidden');
          document.getElementById('app-container').classList.remove('hidden');
          if (!localStorage.getItem('onboarding_completed')) {
            document.getElementById('onboarding-overlay').classList.remove('hidden');
            setupOnboarding();
          } else {
            initializeApp();
          }
        } else {
          pinError.textContent = 'Incorrect PIN. Please try again.';
          pinInput.value = '';
          pinInput.focus();
        }
      });
      pinInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') loginBtn.click();
      });
      pinInput.addEventListener('input', function() { pinError.textContent = ''; });
    }
    
    // Onboarding overlay setup
    function setupOnboarding() {
      document.getElementById('skip-onboarding').addEventListener('click', function() {
        localStorage.setItem('onboarding_completed', 'true');
        document.getElementById('onboarding-overlay').classList.add('hidden');
        initializeApp();
      });
      document.getElementById('start-using-app').addEventListener('click', function() {
        localStorage.setItem('onboarding_completed', 'true');
        document.getElementById('onboarding-overlay').classList.add('hidden');
        initializeApp();
        // Start guided tooltip tour after a slight delay
        setTimeout(setupOnboardingTour, 700);
      });
    }
    // Onboarding guided tour through tooltips
    function setupOnboardingTour() {
      const steps = [
        { targetId: 'add-lead-btn', message: 'Start here by adding your first lead.' },
        { targetId: 'install-btn', message: 'Install this app on your device for easier access later.' },
        { targetId: 'add-content-btn', message: 'Next, add some content to nurture your leads.' },
        { targetId: 'awareness-count', message: 'Drag leads into stages to track progress.' },
        { targetId: 'leadmanagement', message: 'Click here to view and manage all your leads.' }
      ];
      let currentStep = 0;
      function showStep(stepIndex) {
        const step = steps[stepIndex];
        const target = document.getElementById(step.targetId);
        if (!target) return;
        const tooltip = document.createElement('div');
        tooltip.className = 'onboarding-tooltip';
        tooltip.innerText = step.message;
        document.body.appendChild(tooltip);
        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        const rect = target.getBoundingClientRect();
        const tooltipWidth = 220;
        let left = rect.left + rect.width/2 - tooltipWidth/2;
        left = Math.max(10, Math.min(left, window.innerWidth - tooltipWidth - 10));
        tooltip.style.top = `${rect.bottom + window.scrollY + 10}px`;
        tooltip.style.left = `${left}px`;
        target.classList.add('pulse-highlight');
        const nextBtn = document.createElement('button');
        nextBtn.textContent = stepIndex === steps.length - 1 ? 'Finish' : 'Next';
        nextBtn.className = 'submit-btn';
        nextBtn.style.marginTop = '0.5rem';
        tooltip.appendChild(nextBtn);
        nextBtn.addEventListener('click', () => {
          tooltip.remove();
          target.classList.remove('pulse-highlight');
          if (stepIndex + 1 < steps.length) {
            showStep(stepIndex + 1);
          } else {
            localStorage.setItem('onboarding_completed', 'true');
          }
        });
      }
      showStep(0);
    }
    
    // Initialize app (populate default data if none, set up UI)
    function initializeApp() {
      console.log('Initializing app...');
      // Initialize default storage if empty
      if (!localStorage.getItem('funnel_metadata')) {
        localStorage.setItem('funnel_metadata', JSON.stringify({
          created: new Date().toISOString(),
          version: '1.1',
          last_updated: new Date().toISOString()
        }));
      }
      if (!localStorage.getItem('leads')) {
        const defaultLeads = {
          awareness: [
            {
              id: 'lead-' + Date.now(),
              company: 'Example Corp',
              contact: 'John Smith',
              email: 'john@example.com',
              phone: '555-1234',
              currentStage: 'awareness',
              notes: 'Interested in our blog content',
              contentStrategies: ['content-1'],
              dateAdded: new Date().toISOString(),
              lastContact: new Date().toISOString(),
              industry: 'saas',
              status: 'new',
              value: 5000,
              source: 'website'
            }
          ],
          interest: [
            {
              id: 'lead-' + (Date.now()+1),
              company: 'Sample Inc',
              contact: 'Sarah Johnson',
              email: 'sarah@sample.com',
              phone: '555-5678',
              currentStage: 'interest',
              notes: 'Downloaded our whitepaper',
              contentStrategies: ['content-2'],
              dateAdded: new Date().toISOString(),
              lastContact: new Date().toISOString(),
              industry: 'ecommerce',
              status: 'hot',
              value: 10000,
              source: 'social'
            }
          ],
          intent: [], evaluation: [], purchase: []
        };
        localStorage.setItem('leads', JSON.stringify(defaultLeads));
      }
      if (!localStorage.getItem('content')) {
        const defaultContent = [
          {
            id: 'content-1',
            name: 'Example Blog Post',
            description: 'Introductory product blog post',
            stage: 'awareness',
            type: 'blog',
            link: 'https://example.com/blog/intro',
            targetConversion: 5,
            dateCreated: new Date().toISOString()
          },
          {
            id: 'content-2',
            name: 'Whitepaper PDF',
            description: 'Detailed whitepaper',
            stage: 'interest',
            type: 'other',
            link: '',
            targetConversion: 10,
            dateCreated: new Date().toISOString()
          }
        ];
        localStorage.setItem('content', JSON.stringify(defaultContent));
      }
      // Populate content select options
      populateContentOptions();
      // Load leads and content into UI
      loadLeads();
      loadContent();
      // Setup general event listeners for UI interactions
      setupEventListeners();
      // Update aggregated metrics and advice
      updateAnalytics();
    }
    
    // Populate multi-select content options in all relevant select elements
    function populateContentOptions() {
      const contentItems = JSON.parse(localStorage.getItem('content')) || [];
      const selectElements = document.querySelectorAll('.content-select');
      selectElements.forEach(select => {
        // Clear existing options
        select.innerHTML = '';
        // Add new options
        contentItems.forEach(content => {
          const option = document.createElement('option');
          option.value = content.id;
          option.text = content.name;
          select.appendChild(option);
        });
      });
    }
    
    // Load content items into the content management section
    function loadContent() {
      const contentItems = JSON.parse(localStorage.getItem('content')) || [];
      const container = document.getElementById('content-items-container');
      container.innerHTML = '';
      if (contentItems.length === 0) {
        const emptyMsg = document.createElement('p');
        emptyMsg.className = 'empty-state';
        emptyMsg.innerHTML = '<i class="fas fa-folder-open"></i><br>No content strategies added yet.';
        container.appendChild(emptyMsg);
      } else {
        contentItems.forEach(content => {
          const item = document.createElement('div');
          item.className = 'content-item';
          item.draggable = true;
          // Represent content visually
          item.innerHTML = \`<h4><i class="\${getContentIcon(content.type)}"></i> \${content.name}</h4>
                             <p>\${content.description || ''}</p>\`;
          // Attach event: open edit modal on click
          item.addEventListener('click', () => openEditContentModal(content));
          // Draggable (dragula will handle drop logic)
          container.appendChild(item);
        });
      }
    }
    
    // Determine icon class for content type
    function getContentIcon(type) {
      const icons = {
        blog: 'fas fa-file-alt',
        ebook: 'fas fa-book',
        video: 'fas fa-video',
        webinar: 'fas fa-chalkboard-teacher',
        casestudy: 'fas fa-chart-line',
        demo: 'fas fa-desktop',
        other: 'fas fa-file'
      };
      return icons[type] || icons.other;
    }
    
    // Load leads into funnel stages and lead table
    function loadLeads() {
      const leads = JSON.parse(localStorage.getItem('leads')) || {awareness:[], interest:[], intent:[], evaluation:[], purchase:[]};
      const contentItems = JSON.parse(localStorage.getItem('content')) || [];
      // Clear each stage
      document.querySelectorAll('.stage-body').forEach(container => {
        container.innerHTML = '';
        const stage = container.dataset.dropTarget;
        // Add content badges for that stage
        const stageContent = contentItems.filter(c => c.stage === stage);
        if (stageContent.length > 0) {
          const contentBadges = document.createElement('div');
          contentBadges.className = 'content-badges';
          stageContent.forEach(content => {
            const badge = document.createElement('div');
            badge.className = 'content-badge';
            badge.dataset.contentId = content.id;
            badge.draggable = true;
            badge.title = content.name + "\\n" + content.description;
            badge.innerHTML = \`<i class="\${getContentIcon(content.type)}"></i><span>\${content.name.substring(0,3)}</span>\`;
            badge.addEventListener('click', () => openEditContentModal(content));
            contentBadges.appendChild(badge);
          });
          container.appendChild(contentBadges);
        }
        // Lead cards for each stage
        if (leads[stage] && leads[stage].length === 0) {
          const emptyDiv = document.createElement('div');
          emptyDiv.className = 'empty';
          emptyDiv.textContent = 'Drop leads here';
          container.appendChild(emptyDiv);
        } else if (leads[stage]) {
          leads[stage].forEach(lead => {
            container.appendChild(createLeadCard(lead));
          });
        }
      });
      // Update stage counts
      document.getElementById('awareness-count').textContent = leads.awareness.length;
      document.getElementById('interest-count').textContent = leads.interest.length;
      document.getElementById('consideration-count').textContent = leads.intent.length + leads.evaluation.length + leads.purchase.length;
      // Update the leads table (show 5 most recent leads, or all if less)
      const tableBody = document.getElementById('leads-table-body');
      tableBody.innerHTML = '';
      const allLeads = [];
      for (const [stage, stageLeads] of Object.entries(leads)) {
        stageLeads.forEach(lead => { allLeads.push({ ...lead, stage }); });
      }
      if (allLeads.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="6" style="text-align:center;">No leads found</td>';
        tableBody.appendChild(row);
      } else {
        const recentLeads = allLeads.sort((a,b) => new Date(b.dateAdded) - new Date(a.dateAdded)).slice(0,5);
        recentLeads.forEach(lead => {
          const row = document.createElement('tr');
          row.dataset.leadId = lead.id;
          row.innerHTML = \`
            <td>\${lead.company}</td>
            <td>\${lead.contact}</td>
            <td>\${(lead.stage.charAt(0).toUpperCase() + lead.stage.slice(1))}</td>
            <td>\${(lead.contentStrategies || []).length ? lead.contentStrategies.join(', ') : 'None'}</td>
            <td>\${lead.lastContact ? new Date(lead.lastContact).toLocaleDateString() : 'Never'}</td>
            <td class="actions">
              <button class="edit-btn" data-lead-id="\${lead.id}"><i class="fas fa-edit"></i></button>
              <button class="delete-btn" data-lead-id="\${lead.id}"><i class="fas fa-trash"></i></button>
            </td>\`;
          tableBody.appendChild(row);
        });
      }
      updateTotalLeadsCount();
    }
    
    // Create a draggable lead card element for a funnel stage
    function createLeadCard(lead) {
      const leadCard = document.createElement('div');
      leadCard.className = 'lead-card interactive-element';
      leadCard.draggable = true;
      leadCard.dataset.leadId = lead.id;
      leadCard.dataset.currentStage = lead.currentStage;
      leadCard.innerHTML = \`
        <div class="company">\${lead.company}</div>
        <div class="contact">\${lead.contact || 'No contact'}</div>\`;
      // Add tags for industry and status if present
      const tagsWrapper = document.createElement('div');
      tagsWrapper.className = 'tags-wrapper';
      if (lead.industry) {
        const industryTag = document.createElement('span');
        industryTag.className = 'tag';
        industryTag.textContent = lead.industry;
        tagsWrapper.appendChild(industryTag);
      }
      if (lead.status) {
        const statusTag = document.createElement('span');
        statusTag.className = 'tag';
        statusTag.textContent = lead.status;
        tagsWrapper.appendChild(statusTag);
      }
      if (tagsWrapper.children.length > 0) leadCard.appendChild(tagsWrapper);
      // Drag start event for Dragula (optional highlight)
      leadCard.addEventListener('dragstart', (e) => { e.target.classList.add('dragging'); });
      // Remove dragging class on drag end (handled in Dragula dragend event as well)
      // Open edit modal on click
      leadCard.addEventListener('click', (e) => {
        if (!e.target.classList.contains('dragging')) {
          openEditModal(lead.id);
        }
      });
      return leadCard;
    }
    
    // Open the Edit Lead modal for a given lead ID
    function openEditModal(leadId) {
      const leads = JSON.parse(localStorage.getItem('leads')) || {awareness:[], interest:[], intent:[], evaluation:[], purchase:[]};
      let foundLead = null;
      for (const [stage, stageLeads] of Object.entries(leads)) {
        const match = stageLeads.find(l => l.id === leadId);
        if (match) {
          foundLead = { ...match, stage };
          break;
        }
      }
      if (!foundLead) {
        alert('Lead not found.');
        return;
      }
      // Fill the edit lead form
      document.getElementById('edit-lead-id').value = foundLead.id;
      document.getElementById('edit-lead-company').value = foundLead.company || '';
      document.getElementById('edit-lead-contact').value = foundLead.contact || '';
      document.getElementById('edit-lead-email').value = foundLead.email || '';
      document.getElementById('edit-lead-phone').value = foundLead.phone || '';
      document.getElementById('edit-lead-stage').value = foundLead.stage || foundLead.currentStage || '';
      document.getElementById('edit-lead-source').value = foundLead.source || 'website';
      document.getElementById('edit-lead-industry').value = foundLead.industry || 'other';
      document.getElementById('edit-lead-status').value = foundLead.status || 'new';
      document.getElementById('edit-lead-notes').value = foundLead.notes || '';
      // Multi-select content strategies
      $('#edit-lead-content').val(foundLead.contentStrategies || []).trigger('change');
      // Show modal
      document.getElementById('edit-lead-modal').classList.remove('hidden');
      document.getElementById('edit-lead-modal').classList.add('show');
    }
    
    // Open the Edit Content modal for a content item
    function openEditContentModal(content) {
      if (!content) return;
      console.log('Opening edit modal for content:', content.id);
      document.getElementById('edit-content-id').value = content.id;
      document.getElementById('edit-content-name').value = content.name || '';
      document.getElementById('edit-content-description').value = content.description || '';
      document.getElementById('edit-content-stage').value = content.stage;
      document.getElementById('edit-content-type').value = content.type || 'blog';
      document.getElementById('edit-content-link').value = content.link || '';
      document.getElementById('edit-content-target-conversion').value = content.targetConversion || '';
      document.getElementById('edit-content-modal').classList.remove('hidden');
      document.getElementById('edit-content-modal').classList.add('show');
    }
    
    // Add new lead to storage and update UI
    function addLead() {
      const company = document.getElementById('lead-company').value;
      const contact = document.getElementById('lead-contact').value;
      const email = document.getElementById('lead-email').value;
      const phone = document.getElementById('lead-phone').value;
      const stage = document.getElementById('lead-stage').value;
      const source = document.getElementById('lead-source').value;
      const industry = document.getElementById('lead-industry').value;
      const status = document.getElementById('lead-status').value;
      const notes = document.getElementById('lead-notes').value;
      const contentSelect = document.getElementById('lead-content');
      const contentStrategies = $('#lead-content').val() || [];
      // Create lead object
      const newLead = {
        id: 'lead-' + Date.now(),
        company, contact, email, phone,
        source,
        currentStage: stage,
        industry, status, notes,
        contentStrategies,
        dateAdded: new Date().toISOString(),
        lastContact: new Date().toISOString(),
        value: Math.floor(Math.random()*10000)+1000
      };
      const leads = JSON.parse(localStorage.getItem('leads'));
      leads[stage].push(newLead);
      localStorage.setItem('leads', JSON.stringify(leads));
      document.getElementById('add-lead-modal').classList.add('hidden');
      document.getElementById('lead-form').reset();
      loadLeads();
      updateAnalytics();
      showNotification('Lead added successfully');
    }
    
    // Add new content strategy
    function addContent() {
      const name = document.getElementById('content-name').value;
      const description = document.getElementById('content-description').value;
      const stage = document.getElementById('content-stage').value;
      const type = document.getElementById('content-type').value;
      const link = document.getElementById('content-link').value;
      const targetConversion = document.getElementById('content-target-conversion').value || 0;
      const newContent = {
        id: 'content-' + Date.now(),
        name, description, stage, type, link,
        targetConversion: parseInt(targetConversion),
        dateCreated: new Date().toISOString()
      };
      const contentItems = JSON.parse(localStorage.getItem('content')) || [];
      contentItems.push(newContent);
      localStorage.setItem('content', JSON.stringify(contentItems));
      document.getElementById('add-content-modal').classList.add('hidden');
      document.getElementById('content-form').reset();
      loadLeads();
      loadContent();
      populateContentOptions();
      showNotification('Content strategy added successfully');
    }
    
    // Save changes to an existing lead (edit form)
    function saveLeadChanges() {
      const leadId = document.getElementById('edit-lead-id').value;
      const company = document.getElementById('edit-lead-company').value;
      const contact = document.getElementById('edit-lead-contact').value;
      const email = document.getElementById('edit-lead-email').value;
      const phone = document.getElementById('edit-lead-phone').value;
      const stage = document.getElementById('edit-lead-stage').value;
      const source = document.getElementById('edit-lead-source').value;
      const industry = document.getElementById('edit-lead-industry').value;
      const status = document.getElementById('edit-lead-status').value;
      const notes = document.getElementById('edit-lead-notes').value;
      const contentStrategies = $('#edit-lead-content').val() || [];
      const leads = JSON.parse(localStorage.getItem('leads'));
      let leadFound = false;
      for (const [stageKey, stageLeads] of Object.entries(leads)) {
        const leadIndex = stageLeads.findIndex(lead => lead.id === leadId);
        if (leadIndex !== -1) {
          // If stage changed, move lead to new stage
          const lead = stageLeads[leadIndex];
          if (stageKey !== stage) {
            stageLeads.splice(leadIndex, 1);
            lead.currentStage = stage;
            leads[stage].push(lead);
          }
          // Update lead properties
          lead.company = company;
          lead.contact = contact;
          lead.email = email;
          lead.phone = phone;
          lead.source = source;
          lead.industry = industry;
          lead.status = status;
          lead.notes = notes;
          lead.contentStrategies = contentStrategies;
          lead.lastContact = new Date().toISOString();
          leadFound = true;
          break;
        }
      }
      if (leadFound) {
        localStorage.setItem('leads', JSON.stringify(leads));
        document.getElementById('edit-lead-modal').classList.add('hidden');
        loadLeads();
        updateAnalytics();
        showNotification('Lead updated successfully');
      }
    }
    
    // Save changes to a content item
    function saveContentChanges() {
      const contentId = document.getElementById('edit-content-id').value;
      const name = document.getElementById('edit-content-name').value;
      const description = document.getElementById('edit-content-description').value;
      const stage = document.getElementById('edit-content-stage').value;
      const type = document.getElementById('edit-content-type').value;
      const link = document.getElementById('edit-content-link').value;
      const targetConversion = document.getElementById('edit-content-target-conversion').value;
      const contentItems = JSON.parse(localStorage.getItem('content')) || [];
      const contentIndex = contentItems.findIndex(c => c.id === contentId);
      if (contentIndex !== -1) {
        contentItems[contentIndex] = {
          ...contentItems[contentIndex],
          name, description, stage, type, link,
          targetConversion: parseInt(targetConversion) || 0
        };
        localStorage.setItem('content', JSON.stringify(contentItems));
        document.getElementById('edit-content-modal').classList.add('hidden');
        loadLeads();
        loadContent();
        populateContentOptions();
        showNotification('Content updated successfully');
      } else {
        showNotification('Content not found', 'error');
      }
    }
    
    // Delete a lead by ID (remove from storage and refresh UI)
    function deleteLeadById(leadId) {
      const leads = JSON.parse(localStorage.getItem('leads'));
      let leadFound = false;
      for (const stage of Object.keys(leads)) {
        const leadIndex = leads[stage].findIndex(lead => lead.id === leadId);
        if (leadIndex !== -1) {
          leads[stage].splice(leadIndex, 1);
          leadFound = true;
          break;
        }
      }
      if (leadFound) {
        localStorage.setItem('leads', JSON.stringify(leads));
        loadLeads();
        updateAnalytics();
        showNotification('Lead deleted successfully');
      }
    }
    
    // Delete content by ID
    function deleteContent(contentId) {
      const contentItems = JSON.parse(localStorage.getItem('content')) || [];
      const index = contentItems.findIndex(item => item.id === contentId);
      if (index !== -1) {
        contentItems.splice(index, 1);
        localStorage.setItem('content', JSON.stringify(contentItems));
        loadLeads();
        loadContent();
        populateContentOptions();
        showNotification('Content deleted successfully');
      }
    }
    
    // Setup global event listeners for dynamic elements
    function setupEventListeners() {
      document.addEventListener('click', function(e) {
        // Open Add Lead Modal
        if (e.target.matches('#add-lead-btn, #add-lead-btn *')) {
          document.getElementById('lead-form').reset();
          document.getElementById('add-lead-modal').classList.remove('hidden');
          return;
        }
        // Open Add Content Modal
        if (e.target.matches('#add-content-btn, #add-content-btn *')) {
          document.getElementById('content-form').reset();
          document.getElementById('add-content-modal').classList.remove('hidden');
          return;
        }
        // Close modal (close icon or cancel buttons)
        if (e.target.matches('.close-modal, .close-modal *, .cancel-btn, .cancel-btn *')) {
          document.querySelectorAll('.modal').forEach(modal => modal.classList.add('hidden'));
          return;
        }
        // Refresh smart insights (if such button exists)
        if (e.target.matches('#refresh-advice, #refresh-advice *')) {
          updateAnalytics();
          showNotification('Insights refreshed');
          return;
        }
        // Edit lead via edit button
        if (e.target.matches('.edit-btn, .edit-btn *')) {
          const row = e.target.closest('tr');
          const leadId = row?.dataset.leadId;
          if (leadId) openEditModal(leadId);
          return;
        }
        // Delete lead via trash icon (with confirmation)
        if (e.target.matches('.delete-btn, .delete-btn *')) {
          const btn = e.target.closest('.delete-btn');
          const leadId = btn.dataset.leadId;
          if (leadId && confirm('Are you sure you want to delete this lead?')) {
            deleteLeadById(leadId);
          }
          return;
        }
      });
      // Form submission handlers
      document.getElementById('lead-form').addEventListener('submit', e => {
        e.preventDefault(); addLead();
      });
      document.getElementById('edit-lead-form').addEventListener('submit', e => {
        e.preventDefault(); saveLeadChanges();
      });
      document.getElementById('content-form').addEventListener('submit', e => {
        e.preventDefault(); addContent();
      });
      document.getElementById('edit-content-form').addEventListener('submit', e => {
        e.preventDefault(); saveContentChanges();
      });
      // Delete lead button in edit modal
      document.getElementById('delete-lead-btn').addEventListener('click', e => {
        e.preventDefault();
        const leadId = document.getElementById('edit-lead-id').value;
        if (leadId && confirm('Are you sure you want to delete this lead?')) {
          deleteLeadById(leadId);
          document.getElementById('edit-lead-modal').classList.add('hidden');
        }
      });
      // Clicking outside modals closes them
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
          if (e.target === this) this.classList.add('hidden');
        });
      });
      // Export actions
      document.getElementById('export-pdf').addEventListener('click', exportToPDF);
      document.getElementById('export-excel').addEventListener('click', exportToExcel);
    }
    
    // Update total leads count in header
    function updateTotalLeadsCount() {
      const leads = JSON.parse(localStorage.getItem('leads')) || {awareness:[], interest:[], intent:[], evaluation:[], purchase:[]};
      const total = Object.values(leads).flat().length;
      document.getElementById('total-leads').textContent = total;
    }
    
    // Update conversion rates and analytics metrics
    function updateAnalytics() {
      updateConversionPercentages();
      generateSmartAdvice();
      updateAdvancedAnalytics();
    }
    // Calculate and display conversion percentages for each funnel step
    function updateConversionPercentages() {
      const leads = JSON.parse(localStorage.getItem('leads')) || {awareness:[], interest:[], intent:[], evaluation:[], purchase:[]};
      const totalAwareness = leads.awareness.length;
      const totalInterest = leads.interest.length;
      const totalConsideration = leads.intent.length + leads.evaluation.length;
      const totalPurchase = leads.purchase.length;
      const convAwarenessInterest = totalAwareness ? (totalInterest / totalAwareness * 100).toFixed(0) : 0;
      const convInterestConsideration = totalInterest ? ((totalConsideration + totalPurchase) / totalInterest * 100).toFixed(0) : 0;
      const overallConversion = totalAwareness ? ((totalPurchase / totalAwareness) * 100).toFixed(0) : 0;
      document.getElementById('awareness-interest-rate').textContent = convAwarenessInterest + '%';
      document.getElementById('interest-consideration-rate').textContent = convInterestConsideration + '%';
      document.getElementById('conversion-rate').textContent = overallConversion + '%';
    }
    // Generate smart advice insights
    function generateSmartAdvice() {
      const adviceBox = document.getElementById('funnel-advice');
      adviceBox.innerHTML = '';
      const leads = JSON.parse(localStorage.getItem('leads')) || {awareness:[], interest:[], intent:[], evaluation:[], purchase:[]};
      const totalLeads = Object.values(leads).flat().length;
      const hotLeadsCount = Object.values(leads).flat().filter(l => l.status === 'hot').length;
      const insights = [];
      if (totalLeads === 0) {
        insights.push("No leads in the funnel yet. Start adding leads to see insights.");
      } else {
        insights.push(\`You have \${totalLeads} lead(s) in your funnel.\`);
        if (hotLeadsCount > 0) insights.push(\`There are \${hotLeadsCount} hot lead(s) to prioritize.\`);
        if (leads.purchase.length > 0) insights.push("Congratulations, you have leads in the Purchase stage!");
        if (leads.awareness.length > leads.interest.length) insights.push("Consider nurturing more Awareness leads into the Interest stage.");
        // ... other possible insights ...
      }
      const ul = document.createElement('ul');
      insights.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        ul.appendChild(li);
      });
      adviceBox.appendChild(ul);
    }
    // Advanced analytics calculations (e.g., avg time, etc.)
    function updateAdvancedAnalytics() {
      const leads = JSON.parse(localStorage.getItem('leads')) || {awareness:[], interest:[], intent:[], evaluation:[], purchase:[]};
      const allLeads = Object.values(leads).flat();
      const now = new Date();
      let totalDays = 0;
      let leadCount = 0;
      let hotCount = 0;
      allLeads.forEach(lead => {
        if (lead.dateAdded) {
          const addedDate = new Date(lead.dateAdded);
          const daysInFunnel = (now - addedDate) / (1000*60*60*24);
          totalDays += daysInFunnel;
          leadCount++;
        }
        if (lead.status === 'hot') hotCount++;
      });
      const avgDays = leadCount ? (totalDays / leadCount).toFixed(1) : 0;
      document.getElementById('avg-funnel-time').textContent = avgDays + ' days';
      document.getElementById('hot-leads-count').textContent = hotCount;
      // Placeholder values for now:
      document.getElementById('content-effectiveness').textContent = '68%';
      document.getElementById('engagement-rate').textContent = '42%';
      document.getElementById('response-time').textContent = '2.4 hrs';
      document.getElementById('revenue-potential').textContent = '$' + (allLeads.reduce((sum, l) => sum + (l.value || 0), 0));
    }
    
    // Search leads in table (by company or contact name)
    function searchLeads(query) {
      const rows = document.querySelectorAll('#leads-table-body tr');
      const normalizedQuery = query.toLowerCase();
      rows.forEach(row => {
        if (!row.dataset.leadId) {
          // Show "no leads" row only if no search query
          row.style.display = query ? 'none' : '';
          return;
        }
        const company = row.children[0].textContent.toLowerCase();
        const contact = row.children[1].textContent.toLowerCase();
        if (company.includes(normalizedQuery) || contact.includes(normalizedQuery)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
    
    // Export leads to PDF (simple textual PDF)
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(20);
      doc.text('Marketing Funnel Report', 105, 20, { align: 'center' });
      doc.setFontSize(12);
      doc.text(\`Generated on: \${new Date().toLocaleDateString()}\`, 105, 30, { align: 'center' });
      const leads = JSON.parse(localStorage.getItem('leads')) || {awareness:[], interest:[], intent:[], evaluation:[], purchase:[]};
      let yPosition = 50;
      for (const stage of ['awareness','interest','intent','evaluation','purchase']) {
        const stageLeads = leads[stage];
        if (stageLeads.length) {
          doc.setFontSize(14);
          doc.text(stage.charAt(0).toUpperCase() + stage.slice(1) + ' Stage:', 20, yPosition);
          yPosition += 6;
          doc.setFontSize(11);
          stageLeads.forEach(lead => {
            doc.text(\`- \${lead.company} (\${lead.contact})\`, 30, yPosition);
            yPosition += 5;
          });
          yPosition += 4;
        }
      }
      doc.save('FunnelFlow_Report.pdf');
      showNotification('PDF report generated');
    }
    
    // Export leads to Excel (using SheetJS)
    function exportToExcel() {
      const leadsData = JSON.parse(localStorage.getItem('leads')) || {awareness:[], interest:[], intent:[], evaluation:[], purchase:[]};
      const contentItems = JSON.parse(localStorage.getItem('content')) || [];
      const allLeads = [];
      for (const [stage, stageLeads] of Object.entries(leadsData)) {
        stageLeads.forEach(lead => {
          const contentUsed = (lead.contentStrategies||[]).map(contentId => {
            const content = contentItems.find(c => c.id === contentId);
            return content ? content.name : '';
          }).filter(name => name);
          allLeads.push({
            'Company': lead.company,
            'Contact': lead.contact || '',
            'Email': lead.email || '',
            'Phone': lead.phone || '',
            'Stage': stage.charAt(0).toUpperCase()+stage.slice(1),
            'Industry': lead.industry ? lead.industry.charAt(0).toUpperCase()+lead.industry.slice(1) : '',
            'Status': lead.status ? lead.status.charAt(0).toUpperCase()+lead.status.slice(1) : '',
            'Source': lead.source ? lead.source.charAt(0).toUpperCase()+lead.source.slice(1) : '',
            'Content Used': contentUsed.join(', '),
            'Notes': lead.notes || '',
            'Date Added': lead.dateAdded ? new Date(lead.dateAdded).toLocaleDateString() : '',
            'Last Contact': lead.lastContact ? new Date(lead.lastContact).toLocaleDateString() : '',
            'Value': lead.value || ''
          });
        });
      }
      if (allLeads.length === 0) {
        showNotification('No leads to export', 'error');
        return;
      }
      const ws = XLSX.utils.json_to_sheet(allLeads);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Leads');
      XLSX.writeFile(wb, 'Marketing_Funnel_Leads.xlsx');
      showNotification('Excel file exported successfully');
    }
    
    // Display a toast notification
    function showNotification(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show';
      if (type === 'error') {
        toast.classList.add('error');
      } else {
        toast.classList.remove('error');
      }
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // Setup PWA install button (if needed)
    function setupInstallButton() {
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const installBtn = document.getElementById('install-btn');
        if (!installBtn) return;
        installBtn.style.display = 'block';
        installBtn.addEventListener('click', () => {
          installBtn.style.display = 'none';
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('User accepted the install prompt');
            } else {
              console.log('User dismissed the install prompt');
            }
            deferredPrompt = null;
          });
        });
      });
    }
    
    // Initialize drag-and-drop using Dragula
    (function setupDragAndDrop() {
      setTimeout(() => {
        const containers = Array.from(document.querySelectorAll('.stage-body'));
        const contentContainer = document.getElementById('content-items-container');
        if (contentContainer) containers.push(contentContainer);
        if (containers.length > 0 && window.dragula) {
          const drake = dragula(containers, {
            moves: function(el) {
              return el.classList.contains('lead-card') || el.classList.contains('content-badge') || el.classList.contains('content-item');
            }
          });
          drake.on('drop', function(el, target, source) {
            const fromStage = source.dataset.dropTarget || 'content-container';
            const toStage = target.dataset.dropTarget || 'content-container';
            if (el.classList.contains('lead-card')) {
              const leadId = el.dataset.leadId;
              if (fromStage && toStage && fromStage !== toStage) moveLead(leadId, fromStage, toStage);
            } else if (el.classList.contains('content-badge') || el.classList.contains('content-item')) {
              const contentId = el.dataset.contentId;
              if (fromStage !== toStage) moveContentToStage(contentId, toStage);
            }
          });
          drake.on('dragend', function(el) {
            el.classList.remove('dragging');
          });
        }
      }, 100);
    })();
    
    // Move a lead from one stage to another (called on drag-and-drop)
    function moveLead(leadId, fromStage, toStage) {
      const leads = JSON.parse(localStorage.getItem('leads'));
      const leadIndex = leads[fromStage].findIndex(lead => lead.id === leadId);
      if (leadIndex === -1) return;
      const lead = leads[fromStage][leadIndex];
      leads[fromStage].splice(leadIndex, 1);
      lead.currentStage = toStage;
      lead.lastContact = new Date().toISOString();
      leads[toStage].push(lead);
      localStorage.setItem('leads', JSON.stringify(leads));
      loadLeads();
      updateAnalytics();
      showNotification(\`Lead moved to \${toStage.charAt(0).toUpperCase()+toStage.slice(1)} stage\`);
    }
    
    // Move content to a different stage on drag-and-drop
    function moveContentToStage(contentId, toStage) {
      const contentItems = JSON.parse(localStorage.getItem('content')) || [];
      const index = contentItems.findIndex(item => item.id === contentId);
      if (index !== -1) {
        contentItems[index].stage = toStage;
        localStorage.setItem('content', JSON.stringify(contentItems));
        showNotification(\`Content moved to \${toStage.charAt(0).toUpperCase()+toStage.slice(1)} stage\`);
        // Re-render funnel and content lists
        loadLeads();
        loadContent();
        populateContentOptions();
      }
    }
    
  </script>
</body>
</html>
