<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/icon.png" type="image/x-icon">
    <title>Marketing Funnel Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.3/dragula.min.css">
    <link rel="manifest" href="manifest.json" type="application/manifest+json">
    <style>
        :root {
            --primary-color: #0E4954; /* Deep teal-ocean */
            --primary-light: #91d8e4; /* Luminous teal for better contrast */
            --primary-dark: #000000; /* Abyss black-blue */
            --primary-glow: 0 0 12px rgba(14, 73, 84, 0.7), 0 0 24px rgba(14, 73, 84, 0.5);
            
            --secondary-color: #0B1B1C; /* Charcoal twilight */
            --accent-color: #58BCC5; /* Glacial shimmer */
            --accent-glow: 0 0 10px rgba(88, 188, 197, 0.6), 0 0 20px rgba(88, 188, 197, 0.3);
            --gold-accent: #BBA45C; /* Ancient bronze-gold */
            --metallic-silver: #8C9AA8; /* Worn silver, aged steel */
            
            --text-primary: #E0F2F1;
            --text-secondary: #B2DFDB;
            --text-muted: #80CBC4;
            
            --success-color: #4CAF50;
            --warning-color: #FFC107;
            --error-color: #F44336;
            
            --stage-awareness: #0E4954;
            --stage-interest: #1B5E6D;
            --stage-intent: #58BCC5;
            --stage-evaluation: #BBA45C;
            --stage-purchase: #4CAF50;
            
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
            padding-top: 20px; /* Added padding to prevent header overlap */
        }

        .smart-advice-box li,
.lead-management-guide li {
    line-height: 1.6;
        font-size: 0.95rem;

}
.smart-advice-box ul,
.lead-management-guide ul {
    padding-left: 1rem;
    margin-top: 0.5rem;
}
        .smart-advice-box h3,
.lead-management-guide h3 {
    margin-bottom: 0.75rem;
}
        .pulse-orb {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background-color: var(--accent-color);
    margin-bottom: 8px;
    animation: pulse-glow 1.5s infinite;
}

@keyframes pulse-glow {
    0% { box-shadow: 0 0 0px var(--accent-color); }
    50% { box-shadow: 0 0 10px var(--accent-color); }
    100% { box-shadow: 0 0 0px var(--accent-color); }
}

.hidden {
    display: none !important;
}

        
        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
            z-index: 1;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            text-align: left;
            max-width: 240px;
            word-wrap: break-word;
            background-color: var(--primary-dark);
            color: var(--text-primary);
            text-align: center;
            border-radius: var(--border-radius);
            padding: 0.6rem 0.9rem;
             transform: translateX(-50%);
            white-space: normal; /* Add this */
            position: absolute;
            z-index: 10;
            bottom: auto;
            top: 150%; 
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
            border: 1px solid var(--primary-color);
            pointer-events: none;
        }


.tooltip .tooltiptext::after {
  content: '';
  position: absolute;
  top: -6px;
  left: 50%;
  transform: translateX(-50%);
  border-width: 6px;
  border-style: solid;
  border-color: transparent transparent var(--primary-dark) transparent;
}
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Auth screen styles */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .auth-box {
            background: var(--secondary-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 400px;
            text-align: center;
            border: 1px solid var(--primary-color);
        }
        
        .auth-box h2 {
            color: var(--accent-color);
            margin-bottom: 1.5rem;
            font-weight: 700;
        }
        
        .auth-box input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: var(--primary-dark);
            color: var(--text-primary);
        }
        
        .auth-box input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(88, 188, 197, 0.3);
        }
        
        .auth-btn {
            background-color: var(--accent-color);
            color: var(--secondary-color);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }
        
        .auth-btn:hover {
            background-color: var(--primary-light);
        }
        
        .error-message {
            color: var(--error-color);
            margin-bottom: 1rem;
            min-height: 1.5rem;
        }
        
        /* App container */
        #app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        /* Header styles - Fixed position */
        header {
            background-color: var(--primary-dark);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--primary-color);
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
        }
        
        .header-left h1 {
           color: var(--accent-color);
           font-size: 1.75rem;
           font-weight: 700;
           padding: 0.5rem 0;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        
        .header-actions {
             flex-wrap: wrap;
             gap: 1.5rem 1.25rem;
             justify-content: flex-start;
             margin-bottom: 1rem;
             display: flex;
             overflow: visible;
             align-items: center; /* NEW */
             justify-content: flex-end;
        }
        
        .action-btn {
            display: flex;
            font-size: 0.8rem;
            min-width: 100px;
            justify-content: center; /* NEW */
            align-items: center;
            height: auto; /* Add this */
            gap: 0.5rem;
            color: var(--secondary-color);
            border: none;
            background: linear-gradient(135deg, var(--accent-color), var(--primary-light));
            padding: 0.4rem 0.8rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }
        
        .action-btn:hover {
            background-color: var(--primary-light);
            color: var(--text-dark);
            transform: scale(1.02);
        }
        
        .analytics-summary {
            display: flex;
            gap: 1.5rem;
            background-color: var(--primary-dark);
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--primary-color);
        }
        
        .analytics-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
            min-width: 100px;
        }
        
        .analytics-item span:first-child {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .analytics-item span:last-child {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--accent-color);
        }
        
        /* Main content */
        .main-content {
            display: flex;
            flex-wrap: wrap;
            overflow-x: auto;
            padding: 2.5rem 2rem; 
            gap: 2rem;
            margin-top: 40px; /* Added margin to account for fixed header */
        }
        
        .funnel-sidebar {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            background-color: var(--primary-dark);
            border-radius: var(--border-radius);
            height: 100%;
            flex-direction: column;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            overflow-y: auto;
            border: 1px solid var(--primary-color);
        }
        
        .leads-management {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            flex: 1;
            background-color: var(--primary-dark);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
             min-width: 0;
            overflow-y: auto;
            border: 1px solid var(--primary-color);
        }

        .leads-table th, .leads-table td {
          padding: 1rem;
             }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .section-header h2 {
            font-size: 1.25rem;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Funnel visualization */
        .funnel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            width: 100%;
            margin-top: 1rem;
        }
        
        .funnel-stage {
            color: white;
            text-align: center;
            padding: 0;
                margin-bottom: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transform-origin: center;
            width: 100%;
            overflow: hidden;
            border: 1px solid var(--primary-color);
            transition: var(--transition);
        }
        
        .funnel-stage:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }
        
        /* Stage Colors */
        .stage-awareness {
            background: linear-gradient(135deg, var(--stage-awareness) 0%, #1B5E6D 100%);
        }

        .stage-interest {
            background: linear-gradient(135deg, var(--stage-interest) 0%, #2A7D8C 100%);
        }

        .stage-intent {
            background: linear-gradient(135deg, var(--stage-intent) 0%, #7AD1D9 100%);
        }
        
        .stage-evaluation {
            background: linear-gradient(135deg, var(--stage-evaluation) 0%, #D4C281 100%);
        }
        
        .stage-purchase {
            background: linear-gradient(135deg, var(--stage-purchase) 0%, #66BB6A 100%);
        }

        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            position: relative;
            min-height: 60px;
            box-sizing: border-box;
            cursor: pointer;
        }

        .stage-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #fff;
            font-weight: 500;
        }

        .stage-stats {
            display: flex;
            gap: 1.5rem;
            padding: 0 1rem; 
        }

        .stat-item {
            text-align: center;
            min-width: 50px;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
            display: block;
        }

        .stat-label {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.8);
            display: block;
            text-transform: uppercase;
        }
        
       .stage-body {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 1rem;
    max-height: 300px;
    overflow-y: auto;
    padding: 1rem;
    background: rgba(0,0,0,0.2);
    min-height: 100px;
    transition: var(--transition);
}


        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.7);
            height: 100%;
            padding: 1rem;
            box-sizing: border-box;
        }

        .empty-state i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            opacity: 0.7;
        }

        .empty-state p {
            margin: 0;
            font-size: 0.9rem;
        }
        
        /* Sublevels */
        .stage-sublevels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(0,0,0,0.1);
            flex: 1;
        }

        .sublevel {
            background: rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: var(--transition);
        }
        
        .sublevel:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .sublevel-header {
            margin: 0;
            padding: 0.75rem;
            font-size: 0.9rem;
            text-align: center;
            background: rgba(0,0,0,0.2);
            color: #fff;
            font-weight: 500;
        }

        .sublevel .stage-body {
            min-height: 80px;
            height: calc(100% - 40px);
        }
        
        /* Lead cards */
.lead-card .company {
    font-weight: 600;
    font-size: 0.75rem;
    margin-bottom: 0.25rem;
    color: var(--text-primary);
}

.lead-card .contact {
    font-size: 0.65rem;
    color: var(--text-muted);
}

.lead-card {
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--accent-color);
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    transition: var(--transition);
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-height: 70px;
}

.lead-card:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: scale(1.02);
    border-left: 3px solid var(--primary-light);
}
.lead-card.saas {
  background-color: rgba(0, 180, 216, 0.25) !important;
  border: 1px solid #00b4d8 !important;
}

.lead-card.healthcare {
  background-color: rgba(255, 99, 132, 0.25) !important;
  border: 1px solid #ff6384 !important;
}

.lead-card.finance {
  background-color: rgba(0, 204, 102, 0.25) !important;
  border: 1px solid #00cc66 !important;
}

.lead-card.media {
  background-color: rgba(255, 51, 153, 0.25) !important;
  border: 1px solid #ff3399 !important;
}

.lead-card.nonprofit {
  background-color: rgba(54, 162, 235, 0.25) !important;
  border: 1px solid #36a2eb !important;
}

.lead-card.travel {
  background-color: rgba(255, 159, 64, 0.25) !important;
  border: 1px solid #ff9f40 !important;
}

.lead-card.logistics {
  background-color: rgba(153, 102, 255, 0.25) !important;
  border: 1px solid #9966ff !important;
}

.lead-card.fashion {
  background-color: rgba(255, 102, 178, 0.25) !important;
  border: 1px solid #ff66b2 !important;
}

.lead-card.gaming {
  background-color: rgba(0, 255, 204, 0.25) !important;
  border: 1px solid #00ffcc !important;
}

.lead-card.education {
  background-color: rgba(255, 206, 86, 0.25) !important;
  border: 1px solid #ffce56 !important;
}

.lead-card.realestate {
  background-color: rgba(75, 192, 192, 0.25) !important;
  border: 1px solid #4bc0c0 !important;
}

.lead-card.consulting {
  background-color: rgba(153, 51, 255, 0.25) !important;
  border: 1px solid #9933ff !important;
}


[data-drop-target="awareness"] .lead-card { background-color: rgba(255, 255, 255, 0.06); }
[data-drop-target="interest"] .lead-card { background-color: rgba(91, 206, 250, 0.07); }
[data-drop-target="intent"] .lead-card { background-color: rgba(174, 214, 103, 0.07); }
[data-drop-target="evaluation"] .lead-card { background-color: rgba(255, 224, 102, 0.07); }
[data-drop-target="purchase"] .lead-card { background-color: rgba(255, 255, 255, 0.12); }

        
        /* Content badges */
        .content-badges {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
       .content-badge {
    width: auto;
    height: auto;
    padding: 0.3rem 0.6rem;
    border-radius: 12px;
    font-size: 0.7rem;
    background-color: rgba(88,188,197,0.2);
    color: var(--accent-color);
    border: 1px solid var(--primary-light);
}

        
        .content-badge:hover {
            transform: scale(1.1);
            background-color: var(--primary-light);
        }
        
        .content-badge i {
            font-size: 0.8rem;
        }
        
        /* Leads table */
        .leads-table-container {
            max-height: 500px;
            overflow-x: auto;
            overflow-y: auto;
        }
        
        .leads-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .leads-table th, .leads-table td {
            padding: 0.6rem 0.8rem;
            text-align: left;
            border-bottom: 1px solid var(--primary-color);
            white-space: normal;
            word-break: break-word;
            vertical-align: top;
        }

        .edit-insight-btn {
  margin-top: 10px;
  padding: 8px 12px;
  background-color: #ffe066;
  color: #000;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}
.edit-insight-btn:hover {
  background-color: #ffcc00;
}

        
        .leads-table th {
            font-weight: 600;
            color: var(--accent-color);
            background-color: var(--primary-dark);
        }
        
        .leads-table tr {
            background-color: var(--secondary-color);
        }
        
        .leads-table tr:hover {
            background-color: var(--primary-color);
        }
        
        .edit-btn, .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0.25rem;
            transition: var(--transition);
        }
        
        .edit-btn:hover {
            color: var(--accent-color);
        }
        
        .delete-btn:hover {
            color: var(--error-color);
        }
        
        /* Lead search and filter */
        .lead-actions {
            display: flex;
            gap: 1rem;
        }
        
        .lead-search {
            position: relative;
        }
        
        .lead-search input {
            padding: 0.5rem 1rem 0.5rem 2rem;
            border: 1px solid var(--primary-color);
            border-radius: 20px;
            font-size: 0.9rem;
            width: 200px;
            background-color: var(--primary-dark);
            color: var(--text-primary);
        }
        
        .lead-search i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }
        
        .lead-stage-filter {
            padding: 0.5rem 1rem;
            border: 1px solid var(--primary-color);
            border-radius: 20px;
            font-size: 0.9rem;
            background-color: var(--primary-dark);
            color: var(--text-primary);
            cursor: pointer;
        }
        
        /* Content management section */
        .content-items-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .content-item {
            background-color: var(--primary-dark);
            border-radius: var(--border-radius);
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
            border: 1px solid var(--primary-color);
        }
        
        .content-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            background-color: var(--primary-color);
        }
        
        .content-item h4 {
            margin-bottom: 0.5rem;
            color: var(--accent-color);
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: transparent;
            transition: var(--transition);
        }
        
        .content-item h4:hover {
            text-decoration-color: var(--accent-color);
        }
        
        .content-description {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .stage-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            background-color: var(--primary-color);
            color: var(--text-primary);
            margin-right: 0.5rem;
        }
        
        .content-link {
            color: var(--accent-color);
            font-size: 0.8rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            transition: var(--transition);
        }
        
        .content-link:hover {
            color: var(--primary-light);
        }
        
        .content-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .edit-content {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .edit-content:hover {
            color: var(--accent-color);
        }
        
        /* Install button styles */
        #install-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: var(--accent-color);
            color: var(--secondary-color);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }

        #install-btn:hover {
            background-color: var(--primary-light);
            transform: translateY(-1px);
        }

        #install-btn.hidden {
            display: none !important;
        }
        
        /* Smart advice box */
        .smart-advice-box {
            background-color: var(--primary-dark);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-top: 1.5rem;
            border-left: 4px solid var(--accent-color);
            order: -1; /* Move to top in flex container */
        }
        
        .smart-advice-box h3 {
            color: var(--accent-color);
            margin-bottom: 0.5rem;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .smart-advice-box p {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.5;
        }
        
        .smart-advice-box ul {
            margin-left: 1rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .smart-advice-box li {
            margin-bottom: 0.25rem;
        }
        
        /* Interactive elements */
        .interactive-element {
            cursor: pointer;
            transition: var(--transition);
        }
        
        .interactive-element:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }
        
        /* Pulse animation for important elements */
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: none; }
            50% { transform: scale(1.05); box-shadow: var(--accent-glow); }
            100% { transform: scale(1); box-shadow: none; }
        }

        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0px var(--accent-color); }
            50% { box-shadow: 0 0 10px var(--accent-color); }
            100% { box-shadow: 0 0 0px var(--accent-color); }
        }
        
        .pulse-highlight {
            animation: pulse 2s infinite;
        }

        .pulse-glow {
            animation: pulse-glow 1.5s ease-out;
        }
        
        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: var(--primary-dark);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            position: relative;
            padding: 2rem;
            border: 1px solid var(--primary-color);
        }
        
        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: var(--transition);
        }
        
        .close-modal:hover {
            color: var(--text-primary);
        }
        
        .modal h2 {
            margin-bottom: 1.5rem;
            color: var(--accent-color);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            background-color: var(--primary-dark);
            color: var(--text-primary);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-columns {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .cancel-btn, .submit-btn, .delete-btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }
        
        .submit-btn:hover {
            background-color: var(--primary-light);
            color: var(--text-dark);
            transform: scale(1.02);
        }
        
        .cancel-btn {
            background-color: var(--primary-color);
            border: 1px solid var(--primary-light);
            color: var(--text-primary);
        }
        
        .cancel-btn:hover {
            background-color: var(--primary-light);
        }
        
        .submit-btn {
            background-color: var(--accent-color);
            border: none;
            color: var(--secondary-color);
        }
        
        .submit-btn:hover {
            background-color: var(--primary-light);
        }
        
        .delete-btn {
            background-color: var(--error-color);
            border: none;
            color: var(--text-primary);
        }
        
        .delete-btn:hover {
            background-color: #ff5252;
        }
        
        /* Select2 customization */
        .select2-container {
            width: 100% !important;
            z-index: 2000 !important;
        }
        
        .select2-selection {
            min-height: 45px !important;
            display: flex !important;
            align-items: center !important;
            background-color: var(--primary-dark) !important;
            border: 1px solid var(--primary-color) !important;
            color: var(--text-primary) !important;
        }
        
        .select2-selection__placeholder {
            color: var(--text-muted) !important;
        }
        
        .select2-selection__choice {
            background-color: var(--primary-color) !important;
            border: 1px solid var(--primary-light) !important;
            color: var(--text-primary) !important;
        }
        
        .select2-selection__choice__remove {
            color: var(--text-muted) !important;
        }
        
        .select2-dropdown {
            background-color: var(--primary-dark) !important;
            border: 1px solid var(--primary-color) !important;
        }
        
        .select2-results__option {
            color: var(--text-primary) !important;
            padding: 8px 12px !important;
        }
        
        .select2-results__option--highlighted {
            background-color: var(--accent-color) !important;
            color: var(--secondary-color) !important;
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--success-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
            z-index: 1100;
        }
        
        .toast.error {
            background-color: var(--error-color);
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* Dragula/drag and drop styles */
        .gu-mirror {
            opacity: 0.8;
            transform: rotate(5deg);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3) !important;
            background-color: var(--primary-color) !important;
        }
        
        .gu-transit {
            opacity: 0.2;
        }
        
        .dragging {
            opacity: 0.5;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Onboarding tooltip */
        .onboarding-tooltip {
              background-color: var(--primary-light);
    color: var(--primary-dark);
    padding: 1rem;
    border-radius: 10px;
    width: 220px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 9999;
    font-size: 0.95rem;
    position: absolute;
    transition: all 0.3s ease-in-out;
    animation: floatIn 0.3s ease-out;
        }
        
        .onboarding-tooltip:after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--accent-color) transparent transparent transparent;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }
        
        .empty-state i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .empty-state p {
            margin-top: 0.5rem;
        }
        
        /* Lead management guide */
        .lead-management-guide {
            background-color: var(--primary-dark);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--accent-color);
        }
        
        .lead-management-guide h3 {
            color: var(--accent-color);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .lead-management-guide ul {
            margin-left: 1rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .lead-management-guide li {
            margin-bottom: 0.25rem;
        }
        
        /* Content management guide */
        .content-management-guide {
            background-color: var(--primary-dark);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-top: 1.5rem;
            border-left: 4px solid var(--accent-color);
        }
        
        .content-management-guide h3 {
            color: var(--accent-color);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .content-management-guide ul {
            margin-left: 1rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .content-management-guide li {
            margin-bottom: 0.25rem;
        }

        #installBtn {
  display: none; /* <-- Will stay hidden unless changed */
}

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--primary-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }
        
        /* Focus states for better accessibility */
        button:focus, input:focus, select:focus, textarea:focus {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }
        
        /* Onboarding overlay */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .onboarding-content {
            max-width: 600px;
            background: var(--primary-dark);
            padding: 2rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--accent-color);
        }
        
        .onboarding-steps {
            margin: 1.5rem 0;
        }
        
        .onboarding-step {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            text-align: left;
            gap: 1rem;
        }
        
        .onboarding-step i {
            color: var(--accent-color);
            font-size: 1.2rem;
            margin-top: 0.2rem;
        }
        
        .onboarding-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }
        
        /* Enhanced analytics styles */
        .analytics-details {
            background-color: var(--primary-dark);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 1.5rem;
            border-left: 4px solid var(--gold-accent);
        }
        
        .analytics-details h3 {
            color: var(--gold-accent);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .analytics-card {
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            border: 1px solid var(--primary-color);
        }
        
        .analytics-card h4 {
            color: var(--accent-color);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .analytics-card p {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }
        
        .analytics-card .trend-up {
            color: var(--success-color);
        }
        
        .analytics-card .trend-down {
            color: var(--error-color);
        }
        
        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .analytics-summary {
                justify-content: space-around;
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .analytics-item {
                min-width: 120px;
            }
            
            .analytics-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .header-right {
                flex-direction: column;
                gap: 2.5rem;
                width: 100%;
            }
            
            .header-actions {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .lead-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .lead-search input {
                width: 100%;
            }
            
            .form-columns {
                grid-template-columns: 1fr;
            }
            
            .install-btn {
                bottom: 10px;
                right: 10px;
                padding: 10px 16px;
                font-size: 0.9rem;
            }
            
            .stage-sublevels {
                grid-template-columns: 1fr;
            }
            
            .onboarding-content {
                padding: 1rem;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>

    <!-- Auth Screen -->
    <div id="auth-screen" class="auth-container">
        <div class="auth-box">
            <h2>FunnelFlow Login</h2>
            <input type="password" id="pin-input" placeholder="Enter PIN" maxlength="4">
            <p id="pin-error" class="error-message"></p>
            <button id="login-btn" class="auth-btn">Login</button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <!-- Header -->
        <header>
            <div class="header-left">
                <h1>FunnelFlow <span class="tooltip"><i class="fas fa-info-circle" style="color: var(--text-muted); font-size: 0.8rem;"></i><span class="tooltiptext">Drag & drop leads through your marketing funnel. Track conversions and optimize your content strategy.</span></span></h1>
            </div>
            <div class="header-right">
               <!-- In the header section, add the install button with the other action buttons -->
<div class="header-actions">
    <button id="add-lead-btn" class="action-btn tooltip pulse-on-hover" type="button">
        <i class="fas fa-plus"></i> Add Lead
        <span class="tooltiptext">Add a new lead to your marketing funnel</span>
    </button>
    <button id="add-content-btn" class="action-btn tooltip pulse-on-hover" type="button">
        <i class="fas fa-file-alt"></i> Add Content
    </button>
    <button id="install-btn" class="action-btn hidden">
        <i class="fas fa-download"></i> Install App
        <span class="tooltiptext"></span>
    </button>
    <button id="export-pdf" class="action-btn tooltip pulse-on-hover" type="button">
        <i class="fas fa-file-pdf"></i> Export PDF
        <span class="tooltiptext">Export a PDF report of your funnel</span>
    </button>
    <button id="export-excel" class="action-btn tooltip pulse-on-hover" type="button">
        <i class="fas fa-file-excel"></i> Export Excel
        <span class="tooltiptext">Export all leads to Excel</span>
    </button>

</div>
                <div class="analytics-summary">
                    <div class="analytics-item tooltip">
                        <span>Total Leads</span>
                        <span id="total-leads">0</span>
                        <span class="tooltiptext">Total number of leads in your funnel</span>
                    </div>
                    <div class="analytics-item tooltip">
                        <span>Awareness→Interest</span>
                        <span id="awareness-interest-rate">0%</span>
                        <span class="tooltiptext">Conversion rate from Awareness to Interest stage</span>
                    </div>
                    <div class="analytics-item tooltip">
                        <span>Interest→Consideration</span>
                        <span id="interest-consideration-rate">0%</span>
                        <span class="tooltiptext">Conversion rate from Interest to Consideration stage</span>
                    </div>
                    <div class="analytics-item tooltip">
                        <span>Conversion Rate</span>
                        <span id="conversion-rate">0%</span>
                        <span class="tooltiptext">Overall conversion rate from first contact to purchase</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content - 50/50 Split -->
        <main class="main-content">
            <!-- Left Side: Compact Funnel Visualization -->
            <div class="funnel-sidebar">
                <!-- Smart Advice Box - Moved to top -->
                <div id="smart-advice-box" class="smart-advice-box">
                    <h3><i class="fas fa-robot"></i> Smart Funnel Insights</h3>
                    <div id="funnel-advice">
    <div id="insight-loader" class="pulse-orb hidden"></div>
    <p id="insight-text">Analyzing your funnel data...</p>
</div>
                    <button id="refresh-advice" class="action-btn" style="margin-top: 1rem;">
                        <i class="fas fa-sync-alt"></i> Refresh Insights
                    </button>
                </div>
                
                <div class="section-header">
                    <h2><i class="fas fa-filter"></i> Funnel Visualization</h2>
                    <button id="expand-funnel" class="action-btn">
                        <i class="fas fa-expand"></i> Full View
                    </button>
                </div>
                <div class="funnel-container">
                    <!-- Awareness Stage -->
                    <div class="funnel-stage stage-awareness interactive-element">
                        <div class="stage-header clickable" onclick="window.location.href='https://ilkecandan.github.io/customerjourney/awerenes.html'">
                            <h3>Awareness</h3>
                            <div class="stage-stats">
                                <div class="stat-item">
                                    <span class="stat-value" id="awareness-count">0</span>
                                    <span class="stat-label">Leads</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value" id="awareness-conversion-rate">0%</span>
                                    <span class="stat-label">Conversion</span>
                                </div>
                            </div>
                            <div class="click-hint">
                                <i class="fas fa-external-link-alt"></i>
                            </div>
                        </div>
                        <div class="stage-body" data-drop-target="awareness">
                            <div class="empty-state">
                                <p>Drop leads here</p>
                            </div>
                            <!-- Leads will appear here dynamically -->
                        </div>
                    </div>

                    <!-- Interest Stage -->
                    <div class="funnel-stage stage-interest interactive-element">
                        <div class="stage-header clickable" onclick="window.location.href='https://ilkecandan.github.io/customerjourney/interest.html'">
                            <h3>Interest</h3>
                            <div class="stage-stats">
                                <div class="stat-item">
                                    <span class="stat-value" id="interest-count">0</span>
                                    <span class="stat-label">Leads</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value" id="interest-conversion-rate">0%</span>
                                    <span class="stat-label">Conversion</span>
                                </div>
                            </div>
                            <div class="click-hint">
                                <i class="fas fa-external-link-alt"></i>
                            </div>
                        </div>
                        <div class="stage-body" data-drop-target="interest">
                            <div class="empty-state">
                                <i class="fas fa-hand-pointer"></i>
                                <p>Drop leads here</p>
                            </div>
                            <!-- Leads will appear here dynamically -->
                        </div>
                    </div>

                    <!-- Consideration Stage with Functional Sub-Levels -->
                    <div class="funnel-stage stage-consideration interactive-element">
                        <div class="stage-header clickable" onclick="window.location.href='https://ilkecandan.github.io/customerjourney/consideration.html'">
                            <h3>Consideration</h3>
                            <div class="stage-stats">
                                <div class="stat-item">
                                    <span class="stat-value" id="consideration-count">0</span>
                                    <span class="stat-label">Leads</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value" id="consideration-conversion-rate">0%</span>
                                    <span class="stat-label">Conversion</span>
                                </div>
                            </div>
                            <div class="click-hint">
                                <i class="fas fa-external-link-alt"></i>
                            </div>
                        </div>
                        <div class="stage-sublevels">
                            <div class="sublevel stage-intent interactive-element">
                                <div class="sublevel-header">Intent</div>
                                <div class="stage-body" data-drop-target="intent">
                                    <div class="empty-state">
                                        <i class="fas fa-shopping-cart"></i>
                                        <p>Drop leads here</p>
                                    </div>
                                    <!-- Leads will appear here dynamically -->
                                </div>
                            </div>
                            <div class="sublevel stage-evaluation interactive-element">
                                <div class="sublevel-header">Evaluation</div>
                                <div class="stage-body" data-drop-target="evaluation">
                                    <div class="empty-state">
                                        <i class="fas fa-search"></i>
                                        <p>Drop leads here</p>
                                    </div>
                                    <!-- Leads will appear here dynamically -->
                                </div>
                            </div>
                            <div class="sublevel stage-purchase interactive-element">
                                <div class="sublevel-header">Purchase</div>
                                <div class="stage-body" data-drop-target="purchase">
                                    <div class="empty-state">
                                        <i class="fas fa-check-circle"></i>
                                        <p>Drop leads here</p>
                                    </div>
                                    <!-- Leads will appear here dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Side: Lead Management -->
            <div class="leads-management">
                <div class="section-header">
               <h2><i class="fas fa-users" id="leadmanagement"> </i> <a href="https://ilkecandan.github.io/customerjourney/lead.html" style="color: var(--accent-color); text-decoration: none;">Lead Management</a></h2>
                    <div class="lead-actions">
                        <div class="lead-search tooltip">
                            <input type="text" id="lead-search" placeholder="Search leads...">
                            <i class="fas fa-search"></i>
                            <span class="tooltiptext">Search by company or contact name</span>
                        </div>
                        <div class="tooltip">
                            <select id="lead-stage-filter" class="lead-stage-filter">
                                <option value="all">All Stages</option>
                                <option value="awareness">Awareness</option>
                                <option value="interest">Interest</option>
                                <option value="intent">Intent</option>
                                <option value="evaluation">Evaluation</option>
                                <option value="purchase">Purchase</option>
                            </select>
                            <span class="tooltiptext">Filter leads by funnel stage</span>
                        </div>
                    </div>
                </div>
                
                <!-- Lead Management Guide -->
                <div class="lead-management-guide">
                    <h3>Lead Management Guide</h3>
                    <ul>
                        <li><strong>Add New Leads:</strong> Click "Add Lead" to create new lead records</li>
                        <li><strong>Edit Leads:</strong> Click on any lead or use the edit button in the table</li>
                        <li><strong>Delete Leads:</strong> Remove unwanted leads using the delete button</li>
                        <li><strong>View All Leads:</strong> Browse all leads in the table below</li>
                        <li><strong>Drag & Drop:</strong> Move leads between stages in the funnel visualization</li>
                    </ul>
                </div>

                <div class="leads-table-container">
                    <table class="leads-table">
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Contact</th>
                                <th>Stage</th>
                                <th>Content Used</th>
                                <th>Last Contact</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leads-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center;">No leads found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Enhanced Analytics Section -->
                <div class="analytics-details">
                    <h3><i class="fas fa-chart-line"></i> Advanced Analytics</h3>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h4>Avg. Time in Funnel</h4>
                            <p id="avg-funnel-time">7.2 days</p>
                        </div>
                        <div class="analytics-card">
                            <h4>Hot Leads</h4>
                            <p id="hot-leads-count">12</p>
                        </div>
                        <div class="analytics-card">
                            <h4>Content Effectiveness</h4>
                            <p id="content-effectiveness">68%</p>
                        </div>
                        <div class="analytics-card">
                            <h4>Engagement Rate</h4>
                            <p id="engagement-rate">42%</p>
                        </div>
                        <div class="analytics-card">
                            <h4>Response Time</h4>
                            <p id="response-time">2.4 hrs</p>
                        </div>
                        <div class="analytics-card">
                            <h4>Revenue Potential</h4>
                            <p id="revenue-potential">$24,500</p>
                        </div>
                    </div>
                </div>
                
                <!-- Content Management Section -->
                <div class="section-header" style="margin-top: 2rem;">
                    <h2><i class="fas fa-file-alt"></i> Content Strategies</h2>
                </div>
                
                <!-- Content Management Guide -->
                <div class="content-management-guide">
                    <h3>Content Management Guide</h3>
                    <ul>
                        <li><strong>Add New Content:</strong> Click "Add Content" to create new marketing assets</li>
                        <li><strong>Edit Content:</strong> Click on any content item to modify it</li>
                        <li><strong>Delete Content:</strong> Remove outdated content using the delete button</li>
                        <li><strong>View All Content:</strong> Browse all content strategies below</li>
                        <li><strong>Assign Content:</strong> Link content to leads to track effectiveness</li>
                    </ul>
                </div>
                
                <div id="content-items-container" class="content-items-container">
                    <!-- Content items will be added here by JavaScript -->
                </div>
            </div>
        </main>

        <!-- Add Lead Modal -->
       <!-- ✅ Add New Lead Modal -->
<div id="add-lead-modal" class="modal hidden">
  <div class="modal-content">
    <button class="close-modal" onclick="document.getElementById('add-lead-modal').classList.add('hidden')" type="button">&times;</button>
    <h2>Add New Lead</h2>

    <form id="lead-form">
      <div class="form-columns">
        <div class="form-group">
          <label for="lead-company">Company Name *</label>
          <input type="text" id="lead-company" required>
        </div>

        <div class="form-group">
          <label for="lead-contact">Contact Person *</label>
          <input type="text" id="lead-contact" required>
        </div>

        <div class="form-group">
          <label for="lead-email">Email *</label>
          <input type="email" id="lead-email" required>
        </div>

        <div class="form-group">
          <label for="lead-phone">Phone</label>
          <input type="tel" id="lead-phone">
        </div>

        <div class="form-group">
          <label for="lead-stage">Initial Stage *</label>
          <select id="lead-stage" required>
            <option value="awareness">Awareness</option>
            <option value="interest">Interest</option>
            <option value="intent">Intent</option>
            <option value="evaluation">Evaluation</option>
            <option value="purchase">Purchase</option>
          </select>
        </div>

        <div class="form-group">
          <label for="lead-source">Source</label>
          <select id="lead-source">
            <option value="website">Website</option>
            <option value="social">Social Media</option>
            <option value="referral">Referral</option>
            <option value="event">Event</option>
            <option value="ad">Advertisement</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label for="lead-industry">Industry</label>
          <select id="lead-industry">
            <option value="saas">SaaS</option>
            <option value="ecommerce">E-commerce</option>
            <option value="healthcare">Healthcare</option>
            <option value="realestate">Real Estate</option>
            <option value="education">Education</option>
            <option value="consulting">Consulting</option>
            <option value="finance">Finance</option>
            <option value="media">Media</option>
            <option value="nonprofit">Nonprofit</option>
            <option value="travel">Travel</option>
            <option value="logistics">Logistics</option>
            <option value="fashion">Fashion</option>
            <option value="gaming">Gaming</option>
            <option value="software">Software</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label for="lead-status">Status</label>
          <select id="lead-status">
            <option value="new">New</option>
            <option value="hot">Hot</option>
            <option value="cold">Cold</option>
            <option value="stalled">Stalled</option>
          </select>
        </div>
      </div>

      <div class="form-group full-width">
        <label for="lead-content">Content Strategy</label>
        <select id="lead-content" class="content-select" multiple>
          <!-- Populated by JavaScript -->
        </select>
      </div>

      <div class="form-group full-width">
        <label for="lead-notes">Notes</label>
        <textarea id="lead-notes" rows="3"></textarea>
      </div>

      <div class="form-actions">
        <button type="button" class="cancel-btn" onclick="document.getElementById('add-lead-modal').classList.add('hidden')">Cancel</button>
        <button type="submit" class="submit-btn">Add Lead</button>
      </div>
    </form>
  </div>
</div>

        <!-- Add Content Modal -->
        <div id="add-content-modal" class="modal hidden">
            <div class="modal-content">
                <button class="close-modal" type="button">&times;</button>
                <h2>Add Content Strategy</h2>
                <form id="content-form">
                    <div class="form-group">
                        <label for="content-name">Content Name *</label>
                        <input type="text" id="content-name" required>
                    </div>
                    <div class="form-group">
                        <label for="content-description">Description</label>
                        <textarea id="content-description" rows="2"></textarea>
                    </div>
                    <div class="form-columns">
                        <div class="form-group">
                            <label for="content-stage">Funnel Stage *</label>
                            <select id="content-stage" required>
                                <option value="awareness">Awareness</option>
                                <option value="interest">Interest</option>
                                <option value="intent">Intent</option>
                                <option value="evaluation">Evaluation</option>
                                <option value="purchase">Purchase</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="content-type">Content Type</label>
                            <select id="content-type">
                                <option value="blog">Blog Post</option>
                                <option value="ebook">E-book</option>
                                <option value="video">Video</option>
                                <option value="webinar">Webinar</option>
                                <option value="casestudy">Case Study</option>
                                <option value="demo">Demo</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="content-link">Link (URL)</label>
                            <input type="url" id="content-link">
                        </div>
                        <div class="form-group">
                            <label for="content-target-conversion">Target Conversion Rate (%)</label>
                            <input type="number" id="content-target-conversion" min="0" max="100" step="1">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="cancel-btn">Cancel</button>
                        <button type="submit" class="submit-btn">Save Content</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Lead Modal -->
        <div id="edit-lead-modal" class="modal hidden">
            <div class="modal-content">
                <button class="close-modal" type="button">&times;</button>
                <h2>Edit Lead</h2>
                <form id="edit-lead-form">
                    <input type="hidden" id="edit-lead-id">
                    <div class="form-columns">
                        <div class="form-group">
                            <label for="edit-lead-company">Company Name *</label>
                            <input type="text" id="edit-lead-company" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-lead-contact">Contact Person *</label>
                            <input type="text" id="edit-lead-contact" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-lead-email">Email *</label>
                            <input type="email" id="edit-lead-email" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-lead-phone">Phone</label>
                            <input type="tel" id="edit-lead-phone">
                        </div>
                        <div class="form-group">
                            <label for="edit-lead-stage">Current Stage *</label>
                            <select id="edit-lead-stage" required>
                                <option value="awareness">Awareness</option>
                                <option value="interest">Interest</option>
                                <option value="intent">Intent</option>
                                <option value="evaluation">Evaluation</option>
                                <option value="purchase">Purchase</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-lead-source">Source</label>
                            <select id="edit-lead-source">
                                <option value="website">Website</option>
                                <option value="social">Social Media</option>
                                <option value="referral">Referral</option>
                                <option value="event">Event</option>
                                <option value="ad">Advertisement</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-lead-industry">Industry</label>
                            <select id="edit-lead-industry">
                                <option value="saas">SaaS</option>
                                <option value="ecommerce">E-commerce</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="realestate">Real Estate</option>
                                <option value="education">Education</option>
                                <option value="consulting">Consulting</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-lead-status">Status</label>
                            <select id="edit-lead-status">
                                <option value="new">New</option>
                                <option value="hot">Hot</option>
                                <option value="cold">Cold</option>
                                <option value="stalled">Stalled</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="edit-lead-content">Content Strategy</label>
                        <select id="edit-lead-content" class="content-select" multiple>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="edit-lead-notes">Notes</label>
                        <textarea id="edit-lead-notes" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="delete-lead-btn" class="delete-btn">Delete Lead</button>
                        <button type="submit" class="submit-btn">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Content Modal -->
        <div id="edit-content-modal" class="modal hidden">
            <div class="modal-content">
                <button class="close-modal" type="button">&times;</button>
                <h2>Edit Content Strategy</h2>
                <form id="edit-content-form">
                    <input type="hidden" id="edit-content-id">
                    <div class="form-group">
                        <label for="edit-content-name">Content Name *</label>
                        <input type="text" id="edit-content-name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-content-description">Description</label>
                        <textarea id="edit-content-description" rows="2"></textarea>
                    </div>
                    <div class="form-columns">
                        <div class="form-group">
                            <label for="edit-content-stage">Funnel Stage *</label>
                            <select id="edit-content-stage" required>
                                <option value="awareness">Awareness</option>
                                <option value="interest">Interest</option>
                                <option value="intent">Intent</option>
                                <option value="evaluation">Evaluation</option>
                                <option value="purchase">Purchase</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-content-type">Content Type</label>
                            <select id="edit-content-type">
                                <option value="blog">Blog Post</option>
                                <option value="ebook">E-book</option>
                                <option value="video">Video</option>
                                <option value="webinar">Webinar</option>
                                <option value="casestudy">Case Study</option>
                                <option value="demo">Demo</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-content-link">Link (URL)</label>
                            <input type="url" id="edit-content-link">
                        </div>
                        <div class="form-group">
                            <label for="edit-content-target-conversion">Target Conversion Rate (%)</label>
                            <input type="number" id="edit-content-target-conversion" min="0" max="100" step="1">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="cancel-btn">Cancel</button>
                        <button type="submit" class="submit-btn">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="toast"></div>
        
        
        <!-- Onboarding Overlay -->
        <div id="onboarding-overlay" class="onboarding-overlay hidden">
            <div class="onboarding-content">
                <h2>Welcome to FunnelFlow</h2>
                <p>Let's get you started with your marketing funnel management</p>
                
                <div class="onboarding-steps">
                    <div class="onboarding-step">
                        <i class="fas fa-plus-circle"></i>
                        <div>
                            <h4>Add Leads</h4>
                            <p>Start by adding leads to your funnel. Click the "Add Lead" button to create new lead records.</p>
                        </div>
                    </div>
                    <div class="onboarding-step">
                        <i class="fas fa-file-alt"></i>
                        <div>
                            <h4>Create Content</h4>
                            <p>Add content strategies for each stage of your funnel to help move leads forward.</p>
                        </div>
                    </div>
                    <div class="onboarding-step">
                        <i class="fas fa-exchange-alt"></i>
                        <div>
                            <h4>Drag & Drop</h4>
                            <p>Move leads between stages by dragging them to track their progress through the funnel.</p>
                        </div>
                    </div>
                    <div class="onboarding-step">
                        <i class="fas fa-chart-line"></i>
                        <div>
                            <h4>Track Analytics</h4>
                            <p>Monitor conversion rates and get smart insights to optimize your funnel performance.</p>
                        </div>
                    </div>
                </div>
                
                <div class="onboarding-actions">
                    <button id="skip-onboarding" class="cancel-btn">Skip Tutorial</button>
                    <button id="start-using-app" class="submit-btn">Get Started</button>
                    
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script><script>
    if (typeof jQuery === 'undefined') {
        document.write('<script src="/customerjourney/js/jquery-3.6.0.min.js"><\/script>');
    }
</script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.3/dragula.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script>
        let currentSelectedLeadId = null;

        document.addEventListener('DOMContentLoaded', function () {
            // First hide the app container
            document.getElementById('app-container').classList.add('hidden');


            // Check authentication status
            const isAuthenticated = localStorage.getItem('authenticated') === 'true';

            if (isAuthenticated) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                setupInstallButton();
                
                // Check if onboarding has been completed
                if (!localStorage.getItem('onboarding_completed')) {
                    document.getElementById('onboarding-overlay').classList.remove('hidden');
                    setupOnboarding();
                } else {
                    initializeApp();
                }
            } else {
                setupAuth();
            }
        });
 

        // Authentication setup
        function setupAuth() {
            const pinInput = document.getElementById('pin-input');
            const loginBtn = document.getElementById('login-btn');
            const pinError = document.getElementById('pin-error');
            
            // Configurable PINs
            const validPins = ['1234', '4321', '0000'];

            // Focus on the PIN input when the page loads
            pinInput.focus();

            loginBtn.addEventListener('click', function() {
               if (validPins.includes(pinInput.value)) {
                    localStorage.setItem('authenticated', 'true');
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');

                    // Show onboarding if first time
                    if (!localStorage.getItem('onboarding_completed')) {
                        document.getElementById('onboarding-overlay').classList.remove('hidden');
                        setupOnboarding();
                    } else {
                        initializeApp();
                    }
                }
                else {
                    pinError.textContent = 'Incorrect PIN. Please try again.';
                    pinInput.value = '';
                    pinInput.focus();
                }
            });

            // Also allow login on Enter key press
            pinInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loginBtn.click();
                }
            });

            pinInput.addEventListener('input', function() {
                pinError.textContent = '';
            });
        }

        // Onboarding setup
        function setupOnboarding() {
            document.getElementById('skip-onboarding').addEventListener('click', function() {
                localStorage.setItem('onboarding_completed', 'true');
                document.getElementById('onboarding-overlay').classList.add('hidden');
                initializeApp();
            });

            document.getElementById('start-using-app').addEventListener('click', function() {
                localStorage.setItem('onboarding_completed', 'true');
                document.getElementById('onboarding-overlay').classList.add('hidden');
                initializeApp();

                // Start guided tooltip tour
                setTimeout(setupOnboardingTour, 700);
            });
        }

        // Onboarding tour
        function setupOnboardingTour() {
            const steps = [
                {
                    targetId: 'add-lead-btn',
                    message: 'Start here by adding your first lead.'
                },

                {
                    targetId: 'install-btn',
                    message: 'Install this app to your device for easier access later.'
                },

                {
                    targetId: 'add-content-btn',
                    message: 'Now add some content to nurture them.'
                },
            
                {
                    targetId: 'awareness-count',
                    message: 'Drag your leads into the funnel stages to track progress.'
                },

                 {
                    targetId: 'leadmanagement',
                    message: 'Click here for the whole lead list.'
                   },
            ];

            let currentStep = 0;

            function showStep(stepIndex) {
                const step = steps[stepIndex];
                const target = document.getElementById(step.targetId);

                if (!target) return;

             const tooltip = document.createElement('div');
             tooltip.className = 'onboarding-tooltip';
             tooltip.innerText = step.message;

            document.body.appendChild(tooltip);
                    target.scrollIntoView({ behavior: 'smooth', block: 'center' });


              const rect = target.getBoundingClientRect();
              const tooltipWidth = 220;
              let left = rect.left + rect.width / 2 - tooltipWidth / 2;
              left = Math.max(10, Math.min(left, window.innerWidth - tooltipWidth - 10));

              tooltip.style.top = `${rect.bottom + window.scrollY + 10}px`;
              tooltip.style.left = `${left}px`;

                target.classList.add('pulse-highlight');

                const nextBtn = document.createElement('button');
                nextBtn.textContent = stepIndex === steps.length - 1 ? 'Finish' : 'Next';
                nextBtn.className = 'submit-btn';
                nextBtn.style.marginTop = '0.5rem';
                tooltip.appendChild(nextBtn);

                nextBtn.addEventListener('click', () => {
                    tooltip.remove();
                    target.classList.remove('pulse-highlight');
                    if (stepIndex + 1 < steps.length) {
                        showStep(stepIndex + 1);
                    } else {
                        // End of tour
                        localStorage.setItem('onboarding_completed', 'true');
                    }
                });
            }

            showStep(0);
        }

        // Main application initialization
        function initializeApp() {
            console.log('Initializing app...');
            
            // Initialize metadata if none exists
            if (!localStorage.getItem('funnel_metadata')) {
                localStorage.setItem('funnel_metadata', JSON.stringify({
                    created: new Date().toISOString(),
                    version: '1.1',
                    last_updated: new Date().toISOString()
                }));
            }
            
            // Initialize default leads if none exist
            if (!localStorage.getItem('leads')) {
                const defaultLeads = {
                    awareness: [
                        {
                            id: 'lead-' + Date.now(),
                            company: 'Example Corp',
                            contact: 'John Smith',
                            email: 'john@example.com',
                            phone: '555-1234',
                            currentStage: 'awareness',
                            notes: 'Interested in our blog content',
                            contentStrategies: ['content-1'],
                            dateAdded: new Date().toISOString(),
                            lastContact: new Date().toISOString(),
                            industry: 'saas',
                            status: 'new',
                            value: 5000,
                            source: 'website'
                        }
                    ],
                    interest: [
                        {
                            id: 'lead-' + Date.now(),
                            company: 'Sample Inc',
                            contact: 'Sarah Johnson',
                            email: 'sarah@sample.com',
                            phone: '555-5678',
                            currentStage: 'interest',
                            notes: 'Downloaded our whitepaper',
                            contentStrategies: ['content-2'],
                            dateAdded: new Date().toISOString(),
                            lastContact: new Date().toISOString(),
                            industry: 'ecommerce',
                            status: 'hot',
                            value: 10000,
                            source: 'social'
                        }
                    ],
                    intent: [],
                    evaluation: [],
                    purchase: []
                };
                localStorage.setItem('leads', JSON.stringify(defaultLeads));
            }

            // Initialize default content if none exists
            if (!localStorage.getItem('content')) {
                const defaultContent = [
                    {
                        id: 'content-1',
                        name: 'Example Blog Post',
                        description: 'Basic introduction to our product',
                        stage: 'awareness',
                        type: 'blog',
                        link: 'https://example.com/blog/intro',
                        targetConversion: 5,
                        dateCreated: new Date().toISOString()
                    },
                    {
                        id: 'content-2',
                        name: 'Sample Demo Video',
                        description: 'Detailed product demonstration',
                        stage: 'interest',
                        type: 'video',
                        link: 'https://example.com/demo',
                        targetConversion: 15,
                        dateCreated: new Date().toISOString()
                    },
                    {
                        id: 'content-3',
                        name: 'Example Case Study',
                        description: 'Success story from existing customer',
                        stage: 'intent',
                        type: 'casestudy',
                        link: 'https://example.com/case-study',
                        targetConversion: 25,
                        dateCreated: new Date().toISOString()
                    },
                    {
                        id: 'content-4',
                        name: 'Sample Pricing Guide',
                        description: 'Detailed pricing information',
                        stage: 'evaluation',
                        type: 'ebook',
                        link: 'https://example.com/pricing',
                        targetConversion: 20,
                        dateCreated: new Date().toISOString()
                    },
                    {
                        id: 'content-5',
                        name: 'Example Testimonials',
                        description: 'Video testimonials from happy customers',
                        stage: 'purchase',
                        type: 'video',
                        link: 'https://example.com/testimonials',
                        targetConversion: 30,
                        dateCreated: new Date().toISOString()
                    }
                ];
                localStorage.setItem('content', JSON.stringify(defaultContent));
            }

            // Initialize Select2 for content selection
            $('.content-select').select2({
                placeholder: 'Select content strategies',
                width: '100%'
            });

            // Populate content options
            populateContentOptions();

            // Load data and setup UI
            loadLeads();
            loadContent();
            setupEventListeners();
            updateAnalytics();
            setupDragAndDrop();
            setupInstallButton();
        }
        
        document.addEventListener('click', function (e) {
  if (e.target.classList.contains('edit-insight-btn')) {
    const leadId = e.target.dataset.leadId;
    openEditLeadModalById(leadId);
document.getElementById('edit-lead-modal').classList.add('hidden');
  }
});

        // Load leads with content badges

function loadLeads() {
    let leads = JSON.parse(localStorage.getItem('leads')) || {
        awareness: [], interest: [], intent: [], evaluation: [], purchase: []
    };
    const contentItems = JSON.parse(localStorage.getItem('content')) || [];

    // Ensure all leads have an ID
    let updated = false;
    for (const stage of Object.keys(leads)) {
        leads[stage] = leads[stage].map(lead => {
            if (!lead.id) {
                lead.id = 'lead-' + Math.random().toString(36).substr(2, 9);
                updated = true;
            }
            return lead;
        });
    }
    if (updated) {
        localStorage.setItem('leads', JSON.stringify(leads));
    }

    // Clear and populate each stage body
    document.querySelectorAll('.stage-body').forEach(container => {
        container.innerHTML = '';
        const stage = container.dataset.dropTarget;

        // Content badges for this stage
        const stageContent = contentItems.filter(c => c.stage === stage);
        if (stageContent.length > 0) {
            const contentBadges = document.createElement('div');
            contentBadges.className = 'content-badges';

            stageContent.forEach(content => {
                const badge = document.createElement('div');
                badge.className = 'content-badge';
                badge.dataset.contentId = content.id;
                badge.draggable = true;
                badge.title = `${content.name}\n${content.description}`;

                badge.innerHTML = `
                    <i class="${getContentIcon(content.type)}"></i>
                    <span>${content.name.substring(0, 3)}</span>
                `;

                badge.addEventListener('dragstart', handleContentDragStart);
                badge.addEventListener('click', () => openEditContentModal(content));

                contentBadges.appendChild(badge);
            });

            container.appendChild(contentBadges);
        }

        // Lead cards
        if (leads[stage] && leads[stage].length === 0) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'empty';
            emptyDiv.textContent = 'Drop leads here';
            container.appendChild(emptyDiv);
        } else if (leads[stage]) {
            leads[stage].forEach(lead => {
                container.appendChild(createLeadCard(lead));
            });
        }
    });

    // Update funnel stage stats
    document.getElementById('awareness-count').textContent = leads.awareness.length;
    document.getElementById('interest-count').textContent = leads.interest.length;
    document.getElementById('consideration-count').textContent =
        leads.intent.length + leads.evaluation.length + leads.purchase.length;

    // Update leads table
    const tableBody = document.getElementById('leads-table-body');
    tableBody.innerHTML = '';

    const allLeads = [];
    for (const [stage, stageLeads] of Object.entries(leads)) {
        stageLeads.forEach(lead => {
            allLeads.push({ ...lead, stage });
        });
    }

    if (allLeads.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="6" style="text-align: center;">No leads found</td>`;
        tableBody.appendChild(row);
        attachEditButtonListeners();

    } else {
        const recentLeads = allLeads
            .sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded))
            .slice(0, 5);

recentLeads.forEach(lead => {
    const row = document.createElement('tr');
    row.dataset.leadId = lead.id; // Attach lead ID for click-to-edit
    row.innerHTML = `
        <td>${lead.company}</td>
        <td>${lead.contact}</td>
        <td>${capitalizeFirstLetter(lead.stage)}</td>
        <td>${(lead.contentStrategies || []).length > 0 ? lead.contentStrategies.join(', ') : 'None'}</td>
        <td>${lead.lastContact ? new Date(lead.lastContact).toLocaleDateString() : 'Never'}</td>
        <td>
            <button class="edit-btn" data-lead-id="${lead.id}"><i class="fas fa-edit"></i></button>
            <button class="delete-btn" data-lead-id="${lead.id}"><i class="fas fa-trash"></i></button>
        </td>
    `;

    // ✅ Enable row click to open edit modal
    row.addEventListener('click', () => {
        openEditLeadModalById(lead.id); // assumes this function is defined
    });

    tableBody.appendChild(row);
    attachEditButtonListeners();

});

        // Add edit/delete button listeners
document.querySelectorAll('.edit-btn').forEach(btn => {
  btn.addEventListener('click', function (e) {
    e.stopPropagation();
    const leadId = this.dataset.leadId;
    if (leadId) openEditLeadModalById(leadId);
  });
});

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const leadId = btn.dataset.leadId;
                deleteLeadById(leadId);
            });
        });
    }

    updateConversionPercentages();
    generateSmartAdvice();
    updateAdvancedAnalytics();
}
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('side-panel-lead-form');
  if (!form) return;

  form.addEventListener('submit', function (e) {
    e.preventDefault();

    const leadId = document.getElementById('side-lead-id').value;
    const updatedStage = document.getElementById('side-lead-stage').value;
    const leads = JSON.parse(localStorage.getItem('leads')) || {
      awareness: [], interest: [], intent: [], evaluation: [], purchase: []
    };

    let foundLead = null;
    let originalStage = '';
    for (const stage in leads) {
      const index = leads[stage].findIndex(l => l.id === leadId);
      if (index !== -1) {
        foundLead = leads[stage][index];
        leads[stage].splice(index, 1);
        originalStage = stage;
        break;
      }
    }

    if (!foundLead) {
      alert('Lead not found.');
      return;
    }

    const updatedLead = {
      ...foundLead,
      company: document.getElementById('side-lead-company').value,
      contact: document.getElementById('side-lead-contact').value,
      stage: updatedStage,
      lastContact: new Date().toISOString()
    };

    leads[updatedStage].push(updatedLead);
    localStorage.setItem('leads', JSON.stringify(leads));
document.getElementById('edit-lead-modal').classList.add('hidden');
    loadLeads?.();
    updateAnalytics?.();
    showNotification?.('Lead updated successfully');
  });
});



// ✅ OPTIONALLY: FUNNEL INSIGHT REFRESH MOCK
function refreshFunnelInsights() {
  const loader = document.getElementById('insight-loader');
  const text = document.getElementById('insight-text');

  if (loader) loader.classList.remove('hidden');
  if (text) text.textContent = 'Reanalyzing your funnel data...';

  setTimeout(() => {
    if (loader) loader.classList.add('hidden');
    if (text) text.textContent = getRandomInsight(); // If you have a function generating insights
  }, 3000); // Simulated delay
}

// ✅ CONNECT EDIT BUTTONS TO MODAL
document.addEventListener('click', function (e) {
  const btn = e.target.closest('.edit-insight-btn');
  if (btn && btn.dataset.leadId) {
    openEditLeadModalById(btn.dataset.leadId);
  }
});


        

        function setupAutoInsightRefresh(intervalInMinutes = 15) {
    const intervalMs = intervalInMinutes * 60 * 1000;

    setInterval(() => {
        const refreshBtn = document.getElementById('refresh-advice');
        if (refreshBtn) {
            refreshBtn.click(); // trigger funnel insight refresh
        }
    }, intervalMs);
}


        // Update advanced analytics metrics
        function updateAdvancedAnalytics() {
            const leads = JSON.parse(localStorage.getItem('leads')) || {
                awareness: [], interest: [], intent: [], evaluation: [], purchase: []
            };
            
            // Calculate average time in funnel
            const allLeads = Object.values(leads).flat();
            const now = new Date();
            let totalDays = 0;
            let leadCount = 0;
            
            allLeads.forEach(lead => {
                if (lead.dateAdded) {
                    const addedDate = new Date(lead.dateAdded);
                    const daysInFunnel = (now - addedDate) / (1000 * 60 * 60 * 24);
                    totalDays += daysInFunnel;
                    leadCount++;
                }
            });
            
            const avgDays = leadCount > 0 ? (totalDays / leadCount).toFixed(1) : 0;
            document.getElementById('avg-funnel-time').textContent = `${avgDays} days`;
            
            // Count hot leads
            const hotLeads = allLeads.filter(lead => lead.status === 'hot').length;
            document.getElementById('hot-leads-count').textContent = hotLeads;
            
            // Calculate content effectiveness
            const contentItems = JSON.parse(localStorage.getItem('content')) || [];
            let effectiveContentCount = 0;
            let totalContentUsage = 0;
            
            contentItems.forEach(content => {
                const leadsUsingContent = allLeads.filter(lead => 
                    lead.contentStrategies && lead.contentStrategies.includes(content.id)
                ).length;
                
                if (leadsUsingContent > 0) {
                    const nextStageLeads = allLeads.filter(lead => {
                        const currentStageIndex = ['awareness', 'interest', 'intent', 'evaluation', 'purchase'].indexOf(lead.currentStage);
                        const contentStageIndex = ['awareness', 'interest', 'intent', 'evaluation', 'purchase'].indexOf(content.stage);
                        return currentStageIndex > contentStageIndex && 
                               lead.contentStrategies && 
                               lead.contentStrategies.includes(content.id);
                    }).length;
                    
                    if (nextStageLeads > 0) {
                        effectiveContentCount++;
                    }
                    totalContentUsage++;
                }
            });
            
            const effectivenessRate = totalContentUsage > 0 ? 
                Math.round((effectiveContentCount / totalContentUsage) * 100) : 0;
            document.getElementById('content-effectiveness').textContent = `${effectivenessRate}%`;
            
            // Calculate engagement rate (leads contacted in last 7 days)
            const engagedLeads = allLeads.filter(lead => {
                if (!lead.lastContact) return false;
                const lastContactDate = new Date(lead.lastContact);
                const daysSinceContact = (now - lastContactDate) / (1000 * 60 * 60 * 24);
                return daysSinceContact <= 7;
            }).length;
            
            const engagementRate = allLeads.length > 0 ? 
                Math.round((engagedLeads / allLeads.length) * 100) : 0;
            document.getElementById('engagement-rate').textContent = `${engagementRate}%`;
            
            // Calculate average response time (simplified)
            let totalResponseHours = 0;
            let responseCount = 0;
            
            allLeads.forEach(lead => {
                if (lead.dateAdded && lead.lastContact) {
                    const addedDate = new Date(lead.dateAdded);
                    const contactDate = new Date(lead.lastContact);
                    const responseHours = (contactDate - addedDate) / (1000 * 60 * 60);
                    totalResponseHours += responseHours;
                    responseCount++;
                }
            });
            
            const avgResponseTime = responseCount > 0 ? (totalResponseHours / responseCount).toFixed(1) : 0;
            document.getElementById('response-time').textContent = `${avgResponseTime} hrs`;
            
            // Calculate revenue potential (sum of all lead values)
            let revenuePotential = 0;
            allLeads.forEach(lead => {
                if (lead.value) {
                    revenuePotential += lead.value;
                }
            });
            
            document.getElementById('revenue-potential').textContent = `$${revenuePotential.toLocaleString()}`;
        }
        document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const leadId = btn.dataset.leadId;
        const leads = JSON.parse(localStorage.getItem('leads'));
        let foundLead = null;

        for (const stageLeads of Object.values(leads)) {
            const lead = stageLeads.find(l => l.id === leadId);
            if (lead) {
                foundLead = lead;
                break;
            }
        }

        if (foundLead) {
            console.log('Opening edit modal for lead:', leadId); // Debug
    openEditLeadModalById(foundLead.id);
        } else {
            showNotification('Lead not found', 'error');
        }
    });
});


        // Handle content drag start
        function handleContentDragStart(e) {
            e.dataTransfer.setData('text/content-id', e.target.dataset.contentId);
            e.target.classList.add('dragging-content');
        }

        // Load content in the content section
        function loadContent() {
            const contentItems = JSON.parse(localStorage.getItem('content')) || [];
            const container = document.getElementById('content-items-container');
            if (!container) return;

            container.innerHTML = '';

            if (contentItems.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <i class="fas fa-file-alt"></i>
                    <h3>No Content Strategies</h3>
                    <p>Add content to help move leads through your funnel</p>
                    <button id="add-content-empty-btn" class="action-btn" style="margin-top: 1rem;">
                        <i class="fas fa-plus"></i> Add Content
                    </button>
                `;
                container.appendChild(emptyState);
                
                document.getElementById('add-content-empty-btn').addEventListener('click', () => {
                    document.getElementById('content-form').reset();
                    document.getElementById('add-content-modal').classList.remove('hidden');
                });
                return;
            }

            contentItems.forEach(content => {
                const item = document.createElement('div');
                item.className = 'content-item interactive-element';
                item.dataset.contentId = content.id;
                item.dataset.stage = content.stage;
                item.draggable = true;
                
                // Add drag events
                item.addEventListener('dragstart', handleContentItemDragStart);
                
                const icon = document.createElement('i');
                icon.className = getContentIcon(content.type);

                const name = document.createElement('h4');
                name.textContent = content.name;
                name.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditContentModal(content);
                });

                const desc = document.createElement('p');
                desc.className = 'content-description';
                desc.textContent = content.description;

                const stageBadge = document.createElement('span');
                stageBadge.className = 'stage-badge';
                stageBadge.textContent = capitalizeFirstLetter(content.stage);

                const link = document.createElement('a');
                link.href = content.link || '#';
                link.target = '_blank';
                link.className = 'content-link';
                link.innerHTML = '<i class="fas fa-external-link-alt"></i> View';

                const actions = document.createElement('div');
                actions.className = 'content-actions';

                const editBtn = document.createElement('button');
                editBtn.className = 'edit-content';
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditContentModal(content);
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-content';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('Are you sure you want to delete this content strategy?')) {
                        deleteContent(content.id);
                    }
                });

                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);

                item.appendChild(icon);
                item.appendChild(name);
                item.appendChild(desc);
                item.appendChild(stageBadge);
                item.appendChild(link);
                item.appendChild(actions);

                container.appendChild(item);
            });
        }

        // Handle content item drag start
        function handleContentItemDragStart(e) {
            e.dataTransfer.setData('text/content-id', e.target.dataset.contentId);
            e.target.classList.add('dragging-content');
        }

        // Delete content by ID
        function deleteContent(contentId) {
            const contentItems = JSON.parse(localStorage.getItem('content')) || [];
            const updatedContent = contentItems.filter(c => c.id !== contentId);
            localStorage.setItem('content', JSON.stringify(updatedContent));
            
            // Also remove from any leads that might reference this content
            const leads = JSON.parse(localStorage.getItem('leads'));
            for (const stage in leads) {
                leads[stage].forEach(lead => {
                    if (lead.contentStrategies && lead.contentStrategies.includes(contentId)) {
                        lead.contentStrategies = lead.contentStrategies.filter(id => id !== contentId);
                    }
                });
            }
            localStorage.setItem('leads', JSON.stringify(leads));
            
            loadLeads();
            loadContent();
            populateContentOptions();
            showNotification('Content deleted successfully');
        }

        // Create a lead card element for the funnel

function createLeadCard(lead) {
    const leadCard = document.createElement('div');
    leadCard.className = 'lead-card interactive-element';

    // ✅ Add color class based on industry
    if (lead.industry) {
        leadCard.classList.add(lead.industry.toLowerCase()); // makes .saas, .healthcare, etc.
    }

    leadCard.draggable = true;
    leadCard.dataset.leadId = lead.id;
    leadCard.dataset.currentStage = lead.currentStage;

    const company = document.createElement('div');
    company.className = 'company';
    company.textContent = lead.company;

    const contact = document.createElement('div');
    contact.className = 'contact';
    contact.textContent = lead.contact || 'No contact';

    const tagsWrapper = document.createElement('div');
    tagsWrapper.className = 'tags-wrapper';
    tagsWrapper.style.display = 'flex';
    tagsWrapper.style.gap = '4px';
    tagsWrapper.style.marginTop = '4px';

    if (lead.industry) {
        const industryTag = document.createElement('span');
        industryTag.className = 'tag';
        industryTag.textContent = lead.industry;
        tagsWrapper.appendChild(industryTag);
    }

    leadCard.appendChild(company);
    leadCard.appendChild(contact);
    leadCard.appendChild(tagsWrapper);

    // Show Insight Panel on Click
leadCard.addEventListener('click', () => {
  const insight = `Lead has moved ${lead.moves || 0} stages in ${lead.days || 0} days = 🔥HOT!`;
  const contentHTML = `
    <p><strong>Company:</strong> ${lead.company}</p>
    <p><strong>Stage:</strong> ${lead.currentStage}</p>
    <p><strong>Insight:</strong> ${insight}</p>
    <p><strong>Notes:</strong> ${lead.notes || 'No notes'}</p>
<button class="edit-insight-btn" data-lead-id="LEAD_ID">Edit</button>
  `;
  toggleLeadPanel(true, contentHTML);
});


    

    return leadCard;
}
document.addEventListener('click', function (e) {
  const btn = e.target.closest('.edit-insight-btn');
  if (btn && btn.dataset.leadId) {
    openEditLeadModalById(btn.dataset.leadId);
  }
});



function toggleLeadPanel(show, html = '') {
    let panel = document.getElementById('lead-insight-panel');
    if (!panel) {
        panel = document.createElement('div');
        panel.id = 'lead-insight-panel';
        panel.style.position = 'fixed';
        panel.style.top = '0';
        panel.style.right = show ? '0' : '-400px';
        panel.style.width = '360px';
        panel.style.height = '100%';
        panel.style.background = '#0E4954';
        panel.style.color = '#fff';
        panel.style.padding = '20px';
        panel.style.zIndex = '9999';
        panel.style.transition = 'right 0.3s ease-in-out';
        panel.style.overflowY = 'auto';
        document.body.appendChild(panel);
    }
    panel.innerHTML = `<h3>Lead Insight</h3>${html}`;
    panel.style.right = show ? '0' : '-400px';
}

        function saveLeadToLocalStorage(lead) {
    // Initialize lead fields
    if (!lead.id) lead.id = 'lead_' + Date.now();
    if (!lead.createdAt) lead.createdAt = new Date().toISOString();
    if (!lead.moves) lead.moves = 0;
    if (!lead.days) lead.days = 0;

    const leads = JSON.parse(localStorage.getItem('leads')) || {
        awareness: [],
        interest: [],
        intent: [],
        evaluation: [],
        purchase: []
    };

    const stage = lead.currentStage || 'awareness';

    // Remove duplicate if it already exists in any stage
    for (let key in leads) {
        leads[key] = leads[key].filter(l => l.id !== lead.id);
    }

    // Push lead to the correct stage
    leads[stage].push(lead);

    // Save back
    localStorage.setItem('leads', JSON.stringify(leads));
}


function updateLeadsTable() {
    const leadsData = JSON.parse(localStorage.getItem('leads')) || {
        awareness: [], interest: [], intent: [], evaluation: [], purchase: []
    };

    const tableBody = document.getElementById('leads-table-body');
    tableBody.innerHTML = '';

    const allLeads = [];

    for (const [stage, stageLeads] of Object.entries(leadsData)) {
        stageLeads.forEach(lead => {
            if (!lead.id) {
                lead.id = 'lead-' + Math.random().toString(36).substr(2, 9);
            }
            allLeads.push({ ...lead, stage });
        });
    }

    if (allLeads.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="6" style="text-align: center;">No leads found</td>';
        tableBody.appendChild(row);
        attachEditButtonListeners();

        return;
    }

    allLeads.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));

    const contentItems = JSON.parse(localStorage.getItem('content')) || [];

    allLeads.forEach(lead => {
        const row = document.createElement('tr');
        row.dataset.leadId = lead.id;
        row.dataset.stage = lead.stage;

        const contentUsed = lead.contentStrategies?.map(contentId => {
            const content = contentItems.find(c => c.id === contentId);
            return content ? content.name : '';
        }).filter(Boolean) || [];

        const lastContactDate = lead.lastContact
            ? new Date(lead.lastContact).toLocaleDateString()
            : 'Never';

        const companyCell = document.createElement('td');
        companyCell.className = 'company-cell';
        companyCell.textContent = lead.company;

        if (lead.industry || lead.status) {
            const tags = document.createElement('div');
            tags.style.display = 'flex';
            tags.style.gap = '4px';
            tags.style.marginTop = '4px';

            if (lead.industry) {
                const industryTag = document.createElement('span');
                industryTag.style.background = 'var(--primary-color)';
                industryTag.style.padding = '2px 6px';
                industryTag.style.borderRadius = '4px';
                industryTag.style.fontSize = '0.7rem';
                industryTag.textContent = lead.industry;
                tags.appendChild(industryTag);
            }

            if (lead.status) {
                const statusTag = document.createElement('span');
                statusTag.style.background =
                    lead.status === 'hot'
                        ? 'var(--error-color)'
                        : lead.status === 'cold'
                        ? 'var(--accent-color)'
                        : 'var(--text-muted)';
                statusTag.style.padding = '2px 6px';
                statusTag.style.borderRadius = '4px';
                statusTag.style.fontSize = '0.7rem';
                statusTag.textContent = lead.status;
                tags.appendChild(statusTag);
            }

            companyCell.appendChild(tags);
        }

        row.innerHTML = `
            <td class="contact-cell">${lead.contact || 'N/A'}</td>
            <td>${capitalizeFirstLetter(lead.stage)}</td>
            <td>${contentUsed.join(', ') || 'None'}</td>
            <td>${lastContactDate}</td>
            <td>
<button class="edit-btn" data-lead-id="${lead.id}" title="Edit Lead">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="delete-btn" data-lead-id="${lead.id}" title="Delete Lead">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;

        row.insertBefore(companyCell, row.firstChild);
        tableBody.appendChild(row);
        attachEditButtonListeners();


        // ✅ Make the whole row clickable for editing
        row.addEventListener('click', e => {
            const isDeleteClick = e.target.closest('.delete-btn');
            if (!isDeleteClick) {
                openEditLeadModal(lead.id);
            }
        });
    });

    // 🔧 Keep delete working separately
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            e.stopPropagation();
            const leadId = btn.dataset.leadId;
            if (confirm('Are you sure you want to delete this lead?')) {
                deleteLeadById(leadId);
            }
        });
    });
}

        function attachEditButtonListeners() {
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.stopPropagation(); // prevent row click
      const leadId = this.dataset.leadId;
      if (leadId) openEditLeadModalById(leadId);
    });
  });
}


        
        // Helper function to capitalize first letter
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Delete lead by ID

function deleteLeadById(leadId) {
    const leads = JSON.parse(localStorage.getItem('leads')) || {
        awareness: [], interest: [], intent: [], evaluation: [], purchase: []
    };
    let leadFound = false;

    for (const stage of Object.keys(leads)) {
        const leadIndex = leads[stage].findIndex(lead => lead.id === leadId);
        if (leadIndex !== -1) {
            leads[stage].splice(leadIndex, 1);
            leadFound = true;
            break;
        }
    }

    if (leadFound) {
        localStorage.setItem('leads', JSON.stringify(leads));
        loadLeads();
        showNotification('Lead deleted successfully');
    } else {
        showNotification('Error: Lead could not be deleted', 'error');
    }
}


        
        // Fix #3: Event delegation for delete buttons (call this after rendering leads)
function attachDeleteListeners() {
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            e.stopPropagation();
            const leadId = btn.dataset.leadId;
            if (confirm('Are you sure you want to delete this lead?')) {
                deleteLeadById(leadId);
            }
        });
    });
}

        function ensureLeadIds(leads) {
    let updated = false;
    for (const stage of Object.keys(leads)) {
        leads[stage] = leads[stage].map(lead => {
            if (!lead.id) {
                lead.id = generateUniqueId();
                updated = true;
            }
            return lead;
        });
    }
    if (updated) {
        localStorage.setItem('leads', JSON.stringify(leads));
    }
    return leads;
}

        // Get appropriate icon for content type
        function getContentIcon(type) {
            const icons = {
                blog: 'fas fa-file-alt',
                ebook: 'fas fa-book',
                video: 'fas fa-video',
                webinar: 'fas fa-chalkboard-teacher',
                casestudy: 'fas fa-chart-line',
                demo: 'fas fa-desktop',
                other: 'fas fa-file'
            };
            return icons[type] || icons.other;
        }

        function toggleModal(modalId, show = true) {
            const modal = document.getElementById(modalId);
            if (show) {
                modal.classList.remove('hidden');
                modal.classList.add('show');
            } else {
                modal.classList.remove('show');
                modal.classList.add('hidden');
            }
        }

        // Setup event listeners

// Setup event listeners
function setupEventListeners() {
    document.addEventListener('click', function(e) {
        // 🟢 Open Add Lead Modal
        if (e.target.matches('#add-lead-btn, #add-lead-btn *')) {
            document.getElementById('lead-form').reset();
            toggleModal('add-lead-modal', true);
            return;
        }

        // 🟢 Open Add Content Modal
        if (e.target.matches('#add-content-btn, #add-content-btn *, #add-content-empty-btn, #add-content-empty-btn *')) {
            document.getElementById('content-form').reset();
            toggleModal('add-content-modal', true);
            return;
        }

        // 🟡 Close any modal
        if (e.target.matches('.close-modal, .close-modal *, .cancel-btn, .cancel-btn *')) {
            document.querySelectorAll('.modal').forEach(modal => modal.classList.add('hidden'));
            return;
        }

        // 🌀 Refresh Insights
        if (e.target.matches('#refresh-advice, #refresh-advice *')) {
            updateAnalytics();
            showNotification('Insights refreshed');
            return;
        }

        // ✏️ Edit Lead
        if (e.target.matches('.edit-btn, .edit-btn *')) {
            const row = e.target.closest('tr');
            const leadId = row?.dataset.leadId;
            if (!leadId) return;

            const leads = JSON.parse(localStorage.getItem('leads')) || {
                awareness: [], interest: [], intent: [], evaluation: [], purchase: []
            };

            let foundLead = null;
            for (const stageLeads of Object.values(leads)) {
                const match = stageLeads.find(l => l.id === leadId);
                if (match) {
                    foundLead = match;
                    break;
                }
            }

            if (foundLead) {
    openEditLeadModalById(foundLead.id);
            } else {
                showNotification('Lead not found', 'error');
            }
            return;
        }

        // ⬇️ Highlight Funnel
        if (e.target.matches('#expand-funnel, #expand-funnel *')) {
            const funnelContainer = document.querySelector('.funnel-container');
            funnelContainer.classList.add('pulse-highlight');
            setTimeout(() => funnelContainer.classList.remove('pulse-highlight'), 2000);
            return;
        }
    });

    // 📝 Form Submissions
document.getElementById('lead-form')?.addEventListener('submit', e => {
  e.preventDefault();

  const newLead = {
    id: 'lead_' + Date.now(), // ✅ unique ID
    company: document.getElementById('lead-company').value,
    contact: document.getElementById('lead-contact').value,
    email: document.getElementById('lead-email').value,
    phone: document.getElementById('lead-phone').value,
    stage: document.getElementById('lead-stage').value,
    source: document.getElementById('lead-source').value,
    industry: document.getElementById('lead-industry').value,
    status: document.getElementById('lead-status').value,
    contentStrategies: $('#lead-content').val() || [],
    notes: document.getElementById('lead-notes').value,
    lastContact: new Date().toISOString()
  };

  const leads = JSON.parse(localStorage.getItem('leads')) || {
    awareness: [], interest: [], intent: [], evaluation: [], purchase: []
  };

  leads[newLead.stage].push(newLead);
  localStorage.setItem('leads', JSON.stringify(leads));

  document.getElementById('add-lead-modal').classList.add('hidden');
  showNotification?.('Lead added successfully!');
  loadLeads?.();
});


    document.getElementById('edit-lead-form')?.addEventListener('submit', e => {
        e.preventDefault();
        saveLeadChanges();
    });

    document.getElementById('content-form')?.addEventListener('submit', e => {
        e.preventDefault();
        addContent();
    });

    document.getElementById('edit-content-form')?.addEventListener('submit', e => {
        e.preventDefault();
        saveContentChanges();
    });

    // ❌ Delete Lead Button
    document.getElementById('delete-lead-btn')?.addEventListener('click', e => {
        e.preventDefault();
        deleteLead();
    });

    // 🌫 Close modals by clicking outside
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) this.classList.add('hidden');
        });
    });

    // 📦 Export Actions
    document.getElementById('export-pdf')?.addEventListener('click', exportToPDF);
    document.getElementById('export-excel')?.addEventListener('click', exportToExcel);

    // 🔍 Search & Filter
    document.getElementById('lead-stage-filter')?.addEventListener('change', function() {
        filterLeadsTable(this.value);
    });

    const leadSearch = document.getElementById('lead-search');
    if (leadSearch) {
        leadSearch.addEventListener('input', function() {
            clearTimeout(searchLeads.debounce);
            searchLeads.debounce = setTimeout(() => {
                searchLeads(this.value);
            }, 300);
        });
    }
}

function openEditLeadModalById(leadId) {
  const leads = JSON.parse(localStorage.getItem('leads')) || {
    awareness: [], interest: [], intent: [], evaluation: [], purchase: []
  };

  let foundLead = null;
  for (const [stage, list] of Object.entries(leads)) {
    const match = list.find(l => l.id === leadId);
    if (match) {
      foundLead = { ...match, currentStage: stage };
      break;
    }
  }

  if (!foundLead) {
    showNotification('Lead not found', 'error');
    return;
  }

  document.getElementById('side-lead-id').value = foundLead.id;
  document.getElementById('side-lead-company').value = foundLead.company || '';
  document.getElementById('side-lead-contact').value = foundLead.contact || '';
  document.getElementById('side-lead-stage').value = foundLead.currentStage || 'awareness';

document.getElementById('edit-lead-modal').classList.remove('hidden');
}


        // Export to Excel
        function exportToExcel() {
            const leadsData = JSON.parse(localStorage.getItem('leads')) || {
                awareness: [], interest: [], intent: [], evaluation: [], purchase: []
            };
            const contentItems = JSON.parse(localStorage.getItem('content')) || [];
            
            // Combine all leads from all stages
            const allLeads = [];
            for (const [stage, stageLeads] of Object.entries(leadsData)) {
                stageLeads.forEach(lead => {
                    // Get content names for this lead
                    const contentUsed = lead.contentStrategies?.map(contentId => {
                        const content = contentItems.find(c => c.id === contentId);
                        return content ? content.name : '';
                    }).filter(name => name) || [];
                    
                    allLeads.push({
                        'Company': lead.company,
                        'Contact': lead.contact || '',
                        'Email': lead.email || '',
                        'Phone': lead.phone || '',
                        'Stage': capitalizeFirstLetter(stage),
                        'Industry': capitalizeFirstLetter(lead.industry || ''),
                        'Status': capitalizeFirstLetter(lead.status || ''),
                        'Source': capitalizeFirstLetter(lead.source || ''),
                        'Content Used': contentUsed.join(', '),
                        'Notes': lead.notes || '',
                        'Date Added': new Date(lead.dateAdded).toLocaleDateString(),
                        'Last Contact': lead.lastContact ? new Date(lead.lastContact).toLocaleDateString() : '',
                        'Value': lead.value || ''
                    });
                });
            }
            
            if (allLeads.length === 0) {
                showNotification('No leads to export', 'error');
                return;
            }
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(allLeads);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Leads');
            
            // Export to Excel file
            XLSX.writeFile(wb, 'Marketing_Funnel_Leads.xlsx');
            showNotification('Excel file exported successfully');
        }

        // Setup drag and drop functionality

function setupDragAndDrop() {
    setTimeout(() => {
        const containers = Array.from(document.querySelectorAll('.stage-body'));
        const contentContainer = document.getElementById('content-items-container');

        if (contentContainer) containers.push(contentContainer);

        if (containers.length > 0) {
            const drake = dragula(containers, {
                moves: function (el, source, handle, sibling) {
                    return el.classList.contains('lead-card') ||
                        el.classList.contains('content-badge') ||
                        el.classList.contains('content-item');
                }
            });

            drake.on('drop', function (el, target, source, sibling) {
                const fromStage = source.dataset.dropTarget || 'content-container';
                const toStage = target.dataset.dropTarget || 'content-container';

                if (el.classList.contains('lead-card')) {
                    const leadId = el.dataset.leadId;
                    if (fromStage && toStage && fromStage !== toStage) {
                        const leads = JSON.parse(localStorage.getItem('leads')) || {
                            awareness: [], interest: [], intent: [], evaluation: [], purchase: []
                        };
                        let lead = leads[fromStage].find(l => l.id === leadId);
                        if (lead) {
                            leads[fromStage] = leads[fromStage].filter(l => l.id !== leadId);
                            updateLeadMovement(lead, toStage);
                            leads[toStage].push(lead);
                            localStorage.setItem('leads', JSON.stringify(leads));
                            loadLeads();
                        }
                    }
                } else if (el.classList.contains('content-badge') || el.classList.contains('content-item')) {
                    const contentId = el.dataset.contentId;
                    if (fromStage !== toStage) {
                        moveContentToStage(contentId, toStage);
                    }
                }
            });

            drake.on('dragend', function (el) {
                el.classList.remove('dragging-content');
            });
        }
    }, 100);
}
function updateLeadMovement(lead, newStage) {
    if (!lead.createdAt) {
        lead.createdAt = new Date().toISOString();
    }
    if (!lead.moves) lead.moves = 0;
    if (lead.currentStage !== newStage) {
        lead.moves += 1;
        lead.currentStage = newStage;
    }
    const daysPassed = Math.floor((new Date() - new Date(lead.createdAt)) / (1000 * 60 * 60 * 24));
    lead.days = daysPassed;
}
        

        // Move lead between stages
        function moveLead(leadId, fromStage, toStage) {
            const leads = JSON.parse(localStorage.getItem('leads'));
            
            // Find the lead
            const leadIndex = leads[fromStage].findIndex(lead => lead.id === leadId);
            if (leadIndex === -1) return;

            const lead = leads[fromStage][leadIndex];
            
            // Remove from old stage
            leads[fromStage].splice(leadIndex, 1);
            
            // Update lead's current stage
            lead.currentStage = toStage;
            lead.lastContact = new Date().toISOString();
            
            // Add to new stage
            leads[toStage].push(lead);
            
            // Save to storage
            localStorage.setItem('leads', JSON.stringify(leads));
            
            // Update UI
            loadLeads();
            updateAnalytics();
            
            // Show notification
            showNotification(`Lead moved to ${capitalizeFirstLetter(toStage)} stage`);
        }

        // Move content to a different stage
        function moveContentToStage(contentId, toStage) {
            const contentItems = JSON.parse(localStorage.getItem('content')) || [];

            const index = contentItems.findIndex(item => item.id === contentId);
            if (index !== -1) {
                contentItems[index].stage = toStage;
                localStorage.setItem('content', JSON.stringify(contentItems));
                showNotification(`Content moved to ${capitalizeFirstLetter(toStage)} stage`);

                // Re-render updated funnel + content area
                loadLeads();
                loadContent();
                populateContentOptions();
            }
        }

        // Drag start handler
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.leadId);
            e.target.classList.add('dragging');
        }

        // Add a new lead

function addLead() {
  const company = document.getElementById('lead-company').value;
  const contact = document.getElementById('lead-contact').value;
  const email = document.getElementById('lead-email').value;
  const phone = document.getElementById('lead-phone').value;
  const stage = document.getElementById('lead-stage').value;
  const source = document.getElementById('lead-source').value;
  const industry = document.getElementById('lead-industry').value;
  const status = document.getElementById('lead-status').value;
  const notes = document.getElementById('lead-notes').value;

  const contentSelect = document.getElementById('lead-content');
  const contentStrategies = $(contentSelect).val() || [];

  if (!company || !contact || !email) {
    showNotification('Please fill in all required fields', 'error');
    return;
  }

  // ✅ Make sure leads object exists
  const leads = JSON.parse(localStorage.getItem('leads')) || {
    awareness: [], interest: [], intent: [], evaluation: [], purchase: []
  };

  // ✅ Construct new lead
  const newLead = {
    id: 'lead-' + Date.now(), // 🔥 Unique ID is critical for edit
    company,
    contact,
    email,
    phone,
    source,
    stage, // for compatibility
    currentStage: stage, // for display/UI logic
    industry,
    status,
    notes,
    contentStrategies,
    dateAdded: new Date().toISOString(),
    lastContact: new Date().toISOString(),
    value: Math.floor(Math.random() * 10000) + 1000 // Demo value
  };

  // ✅ Push to correct stage
  leads[stage].push(newLead);
  localStorage.setItem('leads', JSON.stringify(leads));

  // ✅ Reset UI
  document.getElementById('add-lead-modal').classList.add('hidden');
  document.getElementById('lead-form').reset();

  loadLeads?.();
  updateAnalytics?.();
  showNotification?.('Lead added successfully');
}
        
        // Add new content strategy
        function addContent() {
            const name = document.getElementById('content-name').value;
            const description = document.getElementById('content-description').value;
            const stage = document.getElementById('content-stage').value;
            const type = document.getElementById('content-type').value;
            const link = document.getElementById('content-link').value;
            const targetConversion = document.getElementById('content-target-conversion').value || 0;

            if (!name || !stage) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            const newContent = {
                id: 'content-' + Date.now(),
                name,
                description,
                stage,
                type,
                link,
                targetConversion: parseInt(targetConversion),
                dateCreated: new Date().toISOString()
            };

            // Add to storage
            const contentItems = JSON.parse(localStorage.getItem('content')) || [];
            contentItems.push(newContent);
            localStorage.setItem('content', JSON.stringify(contentItems));

            // Close modal and reset form
            document.getElementById('add-content-modal').classList.add('hidden');
            document.getElementById('content-form').reset();

            // Update UI
            loadLeads();
            loadContent();
            populateContentOptions();
            showNotification('Content strategy added successfully');
        }

        // Open edit lead modal
        function openEditLeadModal(lead) {
            document.getElementById('edit-lead-id').value = lead.id;
            document.getElementById('edit-lead-company').value = lead.company;
            document.getElementById('edit-lead-contact').value = lead.contact || '';
            document.getElementById('edit-lead-email').value = lead.email || '';
            document.getElementById('edit-lead-phone').value = lead.phone || '';
            document.getElementById('edit-lead-stage').value = lead.currentStage;
            document.getElementById('edit-lead-source').value = lead.source || 'website';
            document.getElementById('edit-lead-industry').value = lead.industry || 'other';
            document.getElementById('edit-lead-status').value = lead.status || 'new';
            document.getElementById('edit-lead-notes').value = lead.notes || '';

            // Set content strategies
            const contentSelect = document.getElementById('edit-lead-content');
            $(contentSelect).val(lead.contentStrategies || []).trigger('change');

            document.getElementById('edit-lead-modal').classList.remove('hidden');
        }

        // Save lead changes
        function saveLeadChanges() {
            const leadId = document.getElementById('edit-lead-id').value;
            const company = document.getElementById('edit-lead-company').value;
            const contact = document.getElementById('edit-lead-contact').value;
            const email = document.getElementById('edit-lead-email').value;
            const phone = document.getElementById('edit-lead-phone').value;
            const stage = document.getElementById('edit-lead-stage').value;
            const source = document.getElementById('edit-lead-source').value;
            const industry = document.getElementById('edit-lead-industry').value;
            const status = document.getElementById('edit-lead-status').value;
            const notes = document.getElementById('edit-lead-notes').value;

            // Get selected content strategies
            const contentSelect = document.getElementById('edit-lead-content');
            const contentStrategies = $(contentSelect).val() || [];

            if (!company || !contact || !email) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            // Update lead in storage
            const leads = JSON.parse(localStorage.getItem('leads'));
            let leadFound = false;

            // Search through all stages to find the lead
            for (const [stageKey, stageLeads] of Object.entries(leads)) {
                const leadIndex = stageLeads.findIndex(lead => lead.id === leadId);
                
                if (leadIndex !== -1) {
                    // If stage changed, move the lead
                    if (stageKey !== stage) {
                        const lead = stageLeads[leadIndex];
                        stageLeads.splice(leadIndex, 1);
                        
                        // Update lead properties
                        lead.company = company;
                        lead.contact = contact;
                        lead.email = email;
                        lead.phone = phone;
                        lead.source = source;
                        lead.industry = industry;
                        lead.status = status;
                        lead.currentStage = stage;
                        lead.notes = notes;
                        lead.contentStrategies = contentStrategies;
                        lead.lastContact = new Date().toISOString();
                        
                        // Add to new stage
                        leads[stage].push(lead);
                    } else {
                        // Just update the lead
                        const lead = stageLeads[leadIndex];
                        lead.company = company;
                        lead.contact = contact;
                        lead.email = email;
                        lead.phone = phone;
                        lead.source = source;
                        lead.industry = industry;
                        lead.status = status;
                        lead.notes = notes;
                        lead.contentStrategies = contentStrategies;
                        lead.lastContact = new Date().toISOString();
                    }
                    
                    leadFound = true;
                    break;
                }
            }

            if (leadFound) {
                localStorage.setItem('leads', JSON.stringify(leads));
                document.getElementById('edit-lead-modal').classList.add('hidden');
                loadLeads();
                updateAnalytics();
                showNotification('Lead updated successfully');
            }
        }

        // Open edit content modal
        function openEditContentModal(content) {
            if (!content) return;
            
            console.log('Opening edit modal for content:', content.id); // Debug log
            
            document.getElementById('edit-content-id').value = content.id;
            document.getElementById('edit-content-name').value = content.name;
            document.getElementById('edit-content-description').value = content.description || '';
            document.getElementById('edit-content-stage').value = content.stage;
            document.getElementById('edit-content-type').value = content.type || 'blog';
            document.getElementById('edit-content-link').value = content.link || '';
            document.getElementById('edit-content-target-conversion').value = content.targetConversion || '';

            const modal = document.getElementById('edit-content-modal');
            modal.classList.remove('hidden');
            modal.classList.add('show');
        }

        // Save content changes
        function saveContentChanges() {
            const contentId = document.getElementById('edit-content-id').value;
            const name = document.getElementById('edit-content-name').value;
            const description = document.getElementById('edit-content-description').value;
            const stage = document.getElementById('edit-content-stage').value;
            const type = document.getElementById('edit-content-type').value;
            const link = document.getElementById('edit-content-link').value;
            const targetConversion = document.getElementById('edit-content-target-conversion').value;

            console.log('Saving content changes for:', contentId); // Debug log

            if (!name || !stage) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            // Update content in storage
            const contentItems = JSON.parse(localStorage.getItem('content')) || [];
            const contentIndex = contentItems.findIndex(c => c.id === contentId);
            
            if (contentIndex !== -1) {
                contentItems[contentIndex] = {
                    ...contentItems[contentIndex],
                    name,
                    description,
                    stage,
                    type,
                    link,
                    targetConversion: parseInt(targetConversion) || 0
                };
                
                localStorage.setItem('content', JSON.stringify(contentItems));
                document.getElementById('edit-content-modal').classList.add('hidden');
                loadLeads();
                loadContent();
                populateContentOptions();
                showNotification('Content updated successfully');
            } else {
                showNotification('Content not found', 'error');
            }
        }
      
        // Delete lead from edit modal
        function deleteLead() {
    const leadId = document.getElementById('edit-lead-id').value;
    if (leadId && confirm('Are you sure you want to delete this lead?')) {
        deleteLeadById(leadId);
        document.getElementById('edit-lead-modal').classList.add('hidden');
    }
}


        // Populate content options in select elements
        function populateContentOptions() {
            const contentItems = JSON.parse(localStorage.getItem('content')) || [];
            const selectElements = document.querySelectorAll('.content-select');
            
            selectElements.forEach(select => {
                // Clear existing options
                $(select).empty();
                
                // Add new options
                contentItems.forEach(content => {
                    const option = new Option(content.name, content.id);
                    $(select).append(option);
                });
            });
        }

        // Calculate key metrics
        function calculateMetrics(leads) {
            const totalLeads = Object.values(leads).flat().length;
            const awarenessCount = leads.awareness.length;
            const interestCount = leads.interest.length;
            const considerationCount = leads.intent.length + leads.evaluation.length;
            const purchaseCount = leads.purchase.length;

            // Conversion rates (dummy basic logic)
            const awarenessToInterest = awarenessCount > 0 ? Math.round((interestCount / awarenessCount) * 100) : 0;
            const interestToConsideration = interestCount > 0 ? Math.round((considerationCount / interestCount) * 100) : 0;
            const totalConversion = totalLeads > 0 ? Math.round((purchaseCount / totalLeads) * 100) : 0;

            // Hot leads count (if status is 'hot')
            const allLeads = Object.values(leads).flat();
            const hotLeads = allLeads.filter(l => l.status === 'hot');

            return {
                totalLeads,
                awarenessToInterest,
                interestToConsideration,
                totalConversion,
                hotLeadCount: hotLeads.length
            };
        }

        // Update conversion percentages between stages
        function updateConversionPercentages() {
            const leads = JSON.parse(localStorage.getItem('leads')) || {
                awareness: [], interest: [], intent: [], evaluation: [], purchase: []
            };

            // Calculate metrics
            const metrics = calculateMetrics(leads);

            // Update DOM with metrics
            document.getElementById('total-leads').textContent = metrics.totalLeads;
            document.getElementById('awareness-interest-rate').textContent = `${metrics.awarenessToInterest}%`;
            document.getElementById('awareness-conversion-rate').textContent = `${metrics.awarenessToInterest}%`;
            document.getElementById('interest-consideration-rate').textContent = `${metrics.interestToConsideration}%`;
            document.getElementById('interest-conversion-rate').textContent = `${metrics.interestToConsideration}%`;
            document.getElementById('conversion-rate').textContent = `${metrics.totalConversion}%`;
            document.getElementById('hot-leads-count').textContent = metrics.hotLeadCount;
            
            // Store metrics in localStorage
            localStorage.setItem('funnel_metrics', JSON.stringify(metrics));
        }

        // Generate smart advice based on funnel state
      function generateSmartAdvice() {
    const metrics = JSON.parse(localStorage.getItem('funnel_metrics')) || {};
    const leads = JSON.parse(localStorage.getItem('leads')) || {
        awareness: [], interest: [], intent: [], evaluation: [], purchase: []
    };
    const contentItems = JSON.parse(localStorage.getItem('content')) || [];
    const allLeads = Object.values(leads).flat();
    const today = new Date();

    const getRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];

    // --- Dynamic Advice Options ---
    const adviceOptions = {
        emptyFunnel: [
    "Your funnel is empty. Add new leads to get started!",
    "No leads yet. Time to hunt down some future customers!",
    "The funnel’s feeling like a ghost town. Invite someone in!",
    "Nothing here yet—this is your sign to populate your funnel!",
    "Imagine a party where no one shows up. That’s your funnel right now.",
    "Even tumbleweeds are getting bored. Add some leads!",
    "Your funnel is zen... but maybe too zen. Let’s stir some action.",
    "This space is full of potential—but zero people. Let’s fix that.",
    "Your funnel is a blank canvas. Time to paint with prospects.",
    "Silence in the funnel doesn’t always mean peace—it means no data to optimize.",
    "Not even a bot would convert here. Add. Some. Humans.",
    "Leads won’t find you through telepathy. Make some noise!",
    "Still waters run deep, but they also don’t pay your bills. Get some traffic in.",
    "Zero leads = zero insights. Start feeding the system.",
    "Your dashboard is lonely. Give it some leads to play with."
],
        noAwareness: [
    "You've skipped the top of the funnel. Add leads to Awareness to keep things flowing smoothly.",
    "No Awareness leads. Top-of-funnel visibility is critical—let’s fix that.",
    "No one knows you exist if Awareness is empty. Start there.",
    "Lead the way—literally. Add leads to the Awareness stage.",
    "Your brand is whispering into the void. Make some noise.",
    "If Awareness is empty, who’s supposed to care? Let them know you’re here.",
    "This is like performing a concert to an empty stadium. Invite an audience.",
    "You're trying to date without saying hello. Awareness is the hello.",
    "Your funnel's top is missing, which makes it more of a... tube?",
    "You can’t have Interest without Awareness. That’s not marketing—that’s magic.",
    "Think of Awareness as lighting the signal fire. Yours is out. Strike the match.",
    "The journey starts here. And right now, there’s no one at the starting line.",
    "No awareness = no brand memory = no clicks = no life. Fix the top.",
    "You're building a castle, but nobody knows the kingdom exists. Send out messengers.",
    "If leads don’t know you exist, they can’t desire, evaluate, or convert. Visibility first."
],

    stuckInInterest: [
    "Your leads are showing interest—that's a great sign. Give them the nudge they need to go further.",
    "They're leaning in. Meet them with clarity, value, and a next step.",
    "This is your moment to shine. A well-timed message or content piece could unlock real movement.",
    "Interest means the door is open. You just need to walk through it with purpose.",
    "They’re curious. Guide them toward consideration with something meaningful.",
    "Don’t underestimate the power of one follow-up. Sometimes that’s all it takes.",
    "Your leads are warm. Stoke the fire with value-packed content or a timely check-in.",
    "They’ve paused, not vanished. Help them take the next step—gently, confidently.",
    "Momentum lives here. A single spark could reignite the journey.",
    "You’ve caught their attention. Now, help them imagine what’s possible with you.",
    "This isn’t stagnation—it’s an invitation. Show up and inspire the next move.",
    "They're interested for a reason. Help them remember why—and show what comes next.",
    "You’re halfway there. Keep the energy up, and the conversions will follow."
],

       noPurchases: [
    "You have leads in Consideration but no purchases. Your closing game is next—refine and shine.",
    "They're almost ready. Strengthen the final touchpoint to guide the decision.",
    "You're so close—help them take the last step with clarity and confidence.",
    "No deals closed yet, but interest is alive. Bring precision to your offer.",
    "Your leads are listening—now give them something undeniable to say yes to.",
    "Consideration is a sign of potential. Make the purchase path feel obvious and safe.",
    "Stuck at the door of Purchase? Sometimes, a stronger CTA or simplified checkout is all it takes.",
    "They’re on the edge. A timely incentive or personalized outreach could tip the scale.",
    "If they’re here, they’re interested. Reaffirm value and remove friction.",
    "This is your closing act. Make it feel like a no-brainer, not a negotiation.",
    "Don’t just sell—resolve. Show them your offer solves their exact problem, beautifully.",
    "If they're hovering, help them land. Use clarity, urgency, and trust signals.",
    "Purchases happen when confidence meets timing. Guide them gently but with purpose."
],

      underperformingContent: [
    "Some content may need improvement: {items}. Consider updating or replacing these assets.",
    "Underperforming content detected: {items}. Time to give them a second life—or a graceful exit.",
    "Not all content converts. These aren’t pulling their weight: {items}. Let’s fix that.",
    "Give these pieces a makeover: {items}. Your funnel deserves better.",
    "These content assets aren’t keeping up: {items}. Refine, refresh, or retire.",
    "Content is only as good as its results. These may need your magic touch: {items}.",
    "These underperformers are costing you momentum: {items}. Time to reimagine.",
    "Great content converts. These ones aren’t: {items}. Find out why.",
    "Your audience deserves clarity—these might be missing the mark: {items}.",
    "Weak links spotted in your content chain: {items}. Strengthen them.",
    "If these pieces were employees, you'd be scheduling performance reviews: {items}.",
    "The data has spoken—these aren’t working: {items}. Let’s do better.",
    "Content is your silent salesperson. These are saying the wrong things: {items}. Rework the script."
],

notContacted: [
    "{count} leads haven't been contacted in over a week. Keep things warm by reaching out again.",
    "You’re ghosting {count} leads. 👻 Maybe it’s time to reconnect?",
    "{count} leads are cooling off. Ping them while there’s still a spark.",
    "A little love goes a long way—contact those {count} leads again!",
    "These {count} leads haven’t heard from you in a while. Don’t let silence kill the momentum.",
    "The trail’s going cold. Reignite connection with {count} leads before it’s too late.",
    "{count} people are waiting for your follow-up. Don’t leave them in limbo.",
    "Conversations go stale fast. Reach out and revive {count} leads.",
    "Every lead ignored is a door closing. You’ve got {count} doors left ajar.",
    "{count} leads are slipping into the void. A quick message could change everything.",
    "They were interested once. Give {count} leads a reason to remember why.",
    "It’s been a while for {count} leads. Send value, not just a ‘Hey.’",
    "Re-engagement isn’t hard—just honest. Talk to those {count} leads again with purpose."
],

    stalledLeads: [
    "{count} leads have been in the same stage for over 2 weeks. Consider re-engaging or qualifying them.",
    "{count} leads are gathering dust. Shake things up!",
    "Those {count} stagnant leads? Time to check if they’re still breathing.",
    "Re-engagement alert: {count} leads are stuck. Rescue time!",
    "{count} leads have been sitting too long. Nudge them—or set them free.",
    "Momentum is fading for {count} leads. Time to re-spark the journey.",
    "{count} leads have lost their way in the funnel. Be the guide back to movement.",
    "Stillness isn’t progress. {count} leads need a reason to move again.",
    "Some leads stall because they’re unsure. Clarify the next step for these {count} wanderers.",
    "You wouldn’t let a friend zone relationship go 2 weeks with silence—do the same for these {count} leads.",
    "{count} leads paused their journey. Help them remember why they started.",
    "Stalled leads = lost signals. Reach out, recalibrate, and reconnect with those {count}."
],
       hotLeads: [
    "You have {count} hot leads. Prioritize these for quick follow-ups and personalized attention.",
    "🔥 {count} hot leads await your charm. Don’t keep them waiting.",
    "{count} hot leads. These are your low-hanging fruit—go pick!",
    "Your {count} hot leads are ready. Move fast, close faster.",
    "If you blink, these {count} hot leads might cool down. Take action now.",
    "These {count} leads are fire. Fan the flames with smart follow-up.",
    "{count} leads are on the edge of a yes. Help them leap.",
    "Don’t let your hottest leads simmer down. Follow up while they’re warm.",
    "{count} leads are already sold—they just need the final nudge.",
    "You're top-of-mind for these {count} leads. Stay there, and close.",
    "These {count} are your funnel’s VIP guests. Treat them like it.",
    "Quick wins live here: {count} hot leads, primed and waiting."
]

    };

    // Calculate conditions
    const stalledLeads = allLeads.filter(lead => {
        if (!lead.dateAdded) return false;
        const addedDate = new Date(lead.dateAdded);
        return (today - addedDate) / (1000 * 60 * 60 * 24) > 14;
    }).length;

    const leadsNotContactedRecently = allLeads.filter(lead => {
        if (!lead.lastContact) return true;
        const lastContactDate = new Date(lead.lastContact);
        return (today - lastContactDate) / (1000 * 60 * 60 * 24) > 7;
    }).length;

    const contentEffectiveness = {};
    contentItems.forEach(content => {
        const leadsUsing = allLeads.filter(l => l.contentStrategies?.includes(content.id)).length;
        if (leadsUsing > 0) {
            const advanced = allLeads.filter(l => {
                const stageIndex = ['awareness','interest','intent','evaluation','purchase'];
                return stageIndex.indexOf(l.currentStage) > stageIndex.indexOf(content.stage) && l.contentStrategies?.includes(content.id);
            }).length;
            const rate = Math.round((advanced / leadsUsing) * 100);
            contentEffectiveness[content.id] = {
                name: content.name,
                rate,
                target: content.targetConversion || 0
            };
        }
    });

    const underperformingContent = Object.entries(contentEffectiveness)
        .filter(([_, stats]) => stats.rate < stats.target)
        .map(([_, stats]) => stats.name);

    // Build advice
    const advice = [];
    const insights = [];

    if (metrics.totalLeads === 0) {
        advice.push(getRandom(adviceOptions.emptyFunnel));
    } else {
        if (leads.awareness.length === 0) {
            advice.push(getRandom(adviceOptions.noAwareness));
        }
        if (leads.interest.length > 0 && (leads.intent.length + leads.evaluation.length) === 0) {
            advice.push(getRandom(adviceOptions.stuckInInterest));
        }
        if (leads.purchase.length === 0 && (leads.intent.length + leads.evaluation.length) > 0) {
            advice.push(getRandom(adviceOptions.noPurchases));
        }
    }

    if (underperformingContent.length > 0) {
        let msg = getRandom(adviceOptions.underperformingContent);
        advice.push(msg.replace('{items}', underperformingContent.join(', ')));
    }

    if (leadsNotContactedRecently > 0) {
        let msg = getRandom(adviceOptions.notContacted);
        advice.push(msg.replace('{count}', leadsNotContactedRecently));
    }

    if (stalledLeads > 0) {
        let msg = getRandom(adviceOptions.stalledLeads);
        advice.push(msg.replace('{count}', stalledLeads));
    }

    if (metrics.hotLeadCount > 0) {
        let msg = getRandom(adviceOptions.hotLeads);
        advice.push(msg.replace('{count}', metrics.hotLeadCount));
    }

    insights.push(`Awareness → Interest conversion: ${metrics.awarenessToInterest || 0}%`);
    insights.push(`Interest → Consideration conversion: ${metrics.interestToConsideration || 0}%`);
    insights.push(`Overall conversion rate: ${metrics.totalConversion || 0}%`);

    // Display in DOM
    const adviceBox = document.getElementById('funnel-advice');
    adviceBox.innerHTML = '';

    if (advice.length > 0) {
        const ul = document.createElement('ul');
        advice.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            ul.appendChild(li);
        });
        adviceBox.appendChild(ul);
    }

    if (insights.length > 0) {
        const header = document.createElement('h4');
        header.textContent = 'Key Metrics:';
        header.style.marginTop = '1rem';
        header.style.color = 'var(--accent-color)';
        adviceBox.appendChild(header);

        const ul = document.createElement('ul');
        insights.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            ul.appendChild(li);
        });
        adviceBox.appendChild(ul);
    }
}


        // Update analytics charts and metrics
        function updateAnalytics() {
            const leads = JSON.parse(localStorage.getItem('leads')) || {
                awareness: [], interest: [], intent: [], evaluation: [], purchase: []
            };

            // Update conversion percentages
            updateConversionPercentages();
            
            // Generate smart advice
            generateSmartAdvice();
            
            // Update advanced analytics
            updateAdvancedAnalytics();
        }

        // Filter leads table by stage
    function filterLeadsTable(stage) {
    const leads = JSON.parse(localStorage.getItem('leads')) || {
        awareness: [], interest: [], intent: [], evaluation: [], purchase: []
    };

    let filtered = [];

    if (stage === 'all') {
        filtered = Object.values(leads).flat();
    } else {
        filtered = leads[stage] || [];
    }

    const sorted = filtered
        .sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded))
        .slice(0, 5);

    renderLeadTable(sorted);
}


        // Search leads
        function searchLeads(query) {
            const rows = document.querySelectorAll('#leads-table-body tr');
            const normalizedQuery = query.toLowerCase();
            
            rows.forEach(row => {
                if (row.dataset.leadId === undefined) {
                    // Show the "no leads" row only if there's no search query
                    row.style.display = query ? 'none' : '';
                    return;
                }
                
                const company = row.querySelector('.company-cell').textContent.toLowerCase();
                const contact = row.querySelector('.contact-cell').textContent.toLowerCase();
                
                if (company.includes(normalizedQuery) || contact.includes(normalizedQuery)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Export to PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.text('Marketing Funnel Report', 105, 20, { align: 'center' });
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
            
            // Add funnel data
            const leads = JSON.parse(localStorage.getItem('leads')) || {
                awareness: [], interest: [], intent: [], evaluation: [], purchase: []
            };
            
            let yPosition = 50;
            
            // Add funnel visualization summary
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 255);
            doc.text('Funnel Summary', 14, yPosition);
            yPosition += 10;
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(`Awareness: ${leads.awareness.length} leads`, 14, yPosition);
            yPosition += 7;
            doc.text(`Interest: ${leads.interest.length} leads`, 14, yPosition);
            yPosition += 7;
            doc.text(`Consideration: ${leads.intent.length + leads.evaluation.length + leads.purchase.length} leads`, 14, yPosition);
            yPosition += 7;
            doc.text(`Purchases: ${leads.purchase.length} leads`, 14, yPosition);
            yPosition += 15;
            
            // Add conversion rates
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 255);
            doc.text('Conversion Rates', 14, yPosition);
            yPosition += 10;
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(`Awareness → Interest: ${document.getElementById('awareness-interest-rate').textContent}`, 14, yPosition);
            yPosition += 7;
            doc.text(`Interest → Consideration: ${document.getElementById('interest-consideration-rate').textContent}`, 14, yPosition);
            yPosition += 7;
            doc.text(`Overall Conversion: ${document.getElementById('conversion-rate').textContent}`, 14, yPosition);
            yPosition += 15;
            
            // Add advanced analytics
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 255);
            doc.text('Advanced Analytics', 14, yPosition);
            yPosition += 10;
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(`Average Time in Funnel: ${document.getElementById('avg-funnel-time').textContent}`, 14, yPosition);
            yPosition += 7;
            doc.text(`Hot Leads: ${document.getElementById('hot-leads-count').textContent}`, 14, yPosition);
            yPosition += 7;
            doc.text(`Content Effectiveness: ${document.getElementById('content-effectiveness').textContent}`, 14, yPosition);
            yPosition += 7;
            doc.text(`Engagement Rate: ${document.getElementById('engagement-rate').textContent}`, 14, yPosition);
            yPosition += 7;
            doc.text(`Average Response Time: ${document.getElementById('response-time').textContent}`, 14, yPosition);
            yPosition += 7;
            doc.text(`Revenue Potential: ${document.getElementById('revenue-potential').textContent}`, 14, yPosition);
            yPosition += 15;
            
            // Add content strategy summary
            const contentItems = JSON.parse(localStorage.getItem('content')) || [];
            if (contentItems.length > 0) {
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 255);
                doc.text('Content Strategy', 14, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                contentItems.forEach(content => {
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.text(`${content.name} (${content.type}) - ${content.stage} stage`, 14, yPosition);
                    yPosition += 7;
                    doc.text(`Target conversion: ${content.targetConversion}%`, 20, yPosition);
                    yPosition += 7;
                });
            }
            
            // Save the PDF
            doc.save('Marketing_Funnel_Report.pdf');
            showNotification('PDF exported successfully');
        }


function generateUniqueId() {
  return 'lead-' + Math.random().toString(36).substr(2, 9);
}


// When adding a new lead (replace your existing lead-adding logic)
function saveNewLead(lead) {
    if (!lead.id) {
        lead.id = generateUniqueId();
    }

    const leads = JSON.parse(localStorage.getItem('leads')) || {
        awareness: [], interest: [], intent: [], evaluation: [], purchase: []
    };

    leads[lead.stage].push(lead);
    localStorage.setItem('leads', JSON.stringify(leads));
    loadLeads();
}

        
        // Install button functionality
        function setupInstallButton() {
  let deferredPrompt;
  const installBtn = document.getElementById('install-btn');

  if (!installBtn) {
    console.error('❌ Install button not found');
    return;
  }

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;

    installBtn.classList.remove('hidden');
    installBtn.style.display = 'inline-flex';

    installBtn.addEventListener('click', async () => {
      installBtn.classList.add('hidden');
      installBtn.style.display = 'none';

      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;

      console.log(`✅ User response: ${outcome}`);
      deferredPrompt = null;
    });
  });

  window.addEventListener('appinstalled', () => {
    console.log('✅ App was installed');
    installBtn.classList.add('hidden');
    installBtn.style.display = 'none';
  });
}


        // Register service worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            }
        }


  // Show or hide the lead side panel (modal)
  function toggleLeadPanel(show, contentHTML = "") {
    const panel = document.getElementById("lead-side-panel");
    if (show) {
      document.getElementById("lead-history-content").innerHTML = contentHTML || "";
      panel.classList.add("show");
      panel.classList.remove("hidden");
    } else {
      panel.classList.remove("show");
      panel.classList.add("hidden");
    }
  }

  // Show toast notification
  function showNotification(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast show';
    if (type === 'error') {
      toast.classList.add('error');
    } else {
      toast.classList.remove('error');
    }

    setTimeout(() => {
      toast.classList.remove('show');
    }, 3000);
  }

  // Register service worker on page load
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('✅ Service worker registered:', reg))
        .catch(err => console.error('❌ Service worker registration failed:', err));
    });
  }

  // Handle PWA install prompt
  let deferredPrompt;

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;

    document.addEventListener('DOMContentLoaded', () => {
      const installBtn = document.getElementById('install-btn');
      if (!installBtn) {
        console.error('Install button not found in DOM');
        return;
      }

      installBtn.style.display = 'block';

      installBtn.addEventListener('click', () => {
        installBtn.style.display = 'none';
        deferredPrompt.prompt();

        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('✅ User accepted the install prompt');
          } else {
            console.log('❌ User dismissed the install prompt');
          }
          deferredPrompt = null;
        });
      });
    });
  });

  // Edit button click (delegated)
  document.addEventListener('click', function (e) {
    const editInsightBtn = e.target.closest('.edit-insight-btn');
    if (!editInsightBtn) return;

    const leadId = editInsightBtn.dataset.leadId;
    if (leadId) {
      openEditLeadModalById(leadId);
    } else {
      console.warn('No lead ID found in edit-insight-btn');
    }
  });

  function toggleLeadPanel(show) {
    const panel = document.getElementById('lead-side-panel');
    if (!panel) return;

    if (show) {
      panel.classList.remove('hidden');
      panel.classList.add('show');
    } else {
      panel.classList.add('hidden');
      panel.classList.remove('show');
    }
  }

  // ✅ Open the side panel with lead data
  function openSidePanelLeadEditor(leadId) {
    const leads = JSON.parse(localStorage.getItem('leads')) || {
      awareness: [], interest: [], intent: [], evaluation: [], purchase: []
    };

    let selected = null;
    let foundStage = null;

    for (const [stage, list] of Object.entries(leads)) {
      const lead = list.find(l => l.id === leadId);
      if (lead) {
        selected = lead;
        foundStage = stage;
        break;
      }
    }

    if (!selected) {
      showNotification?.('Lead not found', 'error');
      return;
    }

    document.getElementById('side-lead-id').value = selected.id;
    document.getElementById('side-lead-company').value = selected.company || '';
    document.getElementById('side-lead-contact').value = selected.contact || '';
    document.getElementById('side-lead-stage').value = foundStage;

    toggleLeadPanel(true);
  }

  // ✅ Save edited lead
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('side-panel-lead-form');
    if (!form) return;

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      const id = document.getElementById('side-lead-id').value;
      const newCompany = document.getElementById('side-lead-company').value;
      const newContact = document.getElementById('side-lead-contact').value;
      const newStage = document.getElementById('side-lead-stage').value;

      const leads = JSON.parse(localStorage.getItem('leads')) || {
        awareness: [], interest: [], intent: [], evaluation: [], purchase: []
      };

      let updatedLead = null;

      for (const [stage, list] of Object.entries(leads)) {
        const idx = list.findIndex(l => l.id === id);
        if (idx !== -1) {
          updatedLead = list[idx];
          list.splice(idx, 1); // remove from old stage
          break;
        }
      }

      if (!updatedLead) {
        showNotification?.('Lead not found for saving', 'error');
        return;
      }

      const updated = {
        ...updatedLead,
        company: newCompany,
        contact: newContact,
        lastContact: new Date().toISOString()
      };

      leads[newStage].push(updated);
      localStorage.setItem('leads', JSON.stringify(leads));

      toggleLeadPanel(false);
      showNotification?.('Lead updated!', 'success');
      loadLeads?.();
    });

    // ✅ Hook edit buttons
    document.addEventListener('click', function (e) {
      const btn = e.target.closest('.edit-insight-btn');
      if (btn && btn.dataset.leadId) {
        openSidePanelLeadEditor(btn.dataset.leadId);
      }
    });
  });
</script>

<!-- ✅ Lead Side Panel for Editing -->
<div id="lead-side-panel" class="modal hidden">
  <div class="modal-content">
    <button class="close-modal" onclick="toggleLeadPanel(false)">&times;</button>
    <h2>Edit Lead</h2>
    <form id="side-panel-lead-form">
      <input type="hidden" id="side-lead-id" />

      <div class="form-group">
        <label for="side-lead-company">Company</label>
        <input type="text" id="side-lead-company" required />
      </div>

      <div class="form-group">
        <label for="side-lead-contact">Contact</label>
        <input type="text" id="side-lead-contact" required />
      </div>

      <div class="form-group">
        <label for="side-lead-stage">Stage</label>
        <select id="side-lead-stage">
          <option value="awareness">Awareness</option>
          <option value="interest">Interest</option>
          <option value="intent">Intent</option>
          <option value="evaluation">Evaluation</option>
          <option value="purchase">Purchase</option>
        </select>
      </div>

      <div class="form-actions">
        <button type="button" class="cancel-btn" onclick="toggleLeadPanel(false)">Cancel</button>
        <button type="submit" class="submit-btn">Save Changes</button>
      </div>
    </form>
  </div>
</div>

</body>
</html>
