<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Sales Funnel Manager</title>
  <meta name="description" content="Manage and visualize your sales funnel with this advanced customer journey tracking tool">
  
  <!-- Preload critical resources -->
  <link rel="preload" href="style.css" as="style">
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style">
  
  <!-- CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="style.css">
  
  <!-- Manifest and theme -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4361ee">
  
  <!-- Favicons -->
  <link rel="icon" href="/icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/icons/icon-512.png">
</head>
<body>
  <!-- Loading indicator (hidden after app loads) -->
  <div id="loadingIndicator" class="loading-indicator">
    <div class="spinner"></div>
    <p>Loading application...</p>
  </div>

  <!-- Error container (shown if initialization fails) -->
  <div id="globalError" class="global-error hidden">
    <div class="error-content">
      <i class="fas fa-exclamation-triangle"></i>
      <h2>Application Failed to Load</h2>
      <p>We encountered an error while loading the application.</p>
      <button id="reloadButton" class="btn btn-primary">
        <i class="fas fa-sync-alt"></i> Refresh Page
      </button>
    </div>
  </div>

  <!-- Main app container (shown after PIN verification) -->
  <div class="app-container hidden">
    <header class="app-header">
      <div class="header-content">
        <h1><i class="fas fa-funnel-dollar" aria-hidden="true"></i> Sales Funnel Manager</h1>
        <p class="subtitle">Visualize and optimize your customer journey</p>
      </div>
      <div class="header-controls">
        <button class="btn btn-primary" onclick="toggleAnalytics()" aria-label="Toggle analytics panel">
          <i class="fas fa-chart-line" aria-hidden="true"></i> Analytics
        </button>
        
        <div class="dropdown">
          <button class="btn btn-secondary" aria-haspopup="true" aria-expanded="false" aria-label="Export options">
            <i class="fas fa-file-export" aria-hidden="true"></i> Export
          </button>
          <div class="dropdown-content" role="menu">
            <a href="#" onclick="exportAsPDF()" role="menuitem">
              <i class="fas fa-file-pdf" aria-hidden="true"></i> PDF
            </a>
            <a href="#" onclick="exportAsJSON()" role="menuitem">
              <i class="fas fa-file-code" aria-hidden="true"></i> JSON
            </a>
            <a href="#" onclick="exportAsCSV()" role="menuitem">
              <i class="fas fa-file-csv" aria-hidden="true"></i> CSV
            </a>
          </div>
        </div>
        
        <button class="btn btn-info" onclick="loadExampleData()" aria-label="Load example data">
          <i class="fas fa-lightbulb" aria-hidden="true"></i> Example
        </button>
      </div>
    </header>

    <main class="funnel-container">
      <!-- TOF Stage -->
      <section class="funnel-stage tof" data-stage="tof" aria-labelledby="tof-heading">
        <div class="stage-header">
          <div class="stage-titles">
            <h2 id="tof-heading">TOF</h2>
            <h3>Top of Funnel</h3>
            <div class="stage-count" aria-live="polite">0</div>
          </div>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress" id="tof-progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <span class="progress-text" id="tof-progress-text">0%</span>
          </div>
        </div>
        <div class="leads-container" id="tof-leads" role="region" aria-labelledby="tof-heading"></div>
        <button class="add-lead-btn" onclick="openAddLeadModal('tof')" aria-label="Add new lead to top of funnel">
          <i class="fas fa-plus" aria-hidden="true"></i> Add Lead
        </button>
      </section>

      <!-- MOF Stage -->
      <section class="funnel-stage mof" data-stage="mof" aria-labelledby="mof-heading">
        <div class="stage-header">
          <div class="stage-titles">
            <h2 id="mof-heading">MOF</h2>
            <h3>Middle of Funnel</h3>
            <div class="stage-count" aria-live="polite">0</div>
          </div>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress" id="mof-progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <span class="progress-text" id="mof-progress-text">0%</span>
          </div>
        </div>
        <div class="leads-container" id="mof-leads" role="region" aria-labelledby="mof-heading"></div>
        <button class="add-lead-btn" onclick="openAddLeadModal('mof')" aria-label="Add new lead to middle of funnel">
          <i class="fas fa-plus" aria-hidden="true"></i> Add Lead
        </button>
      </section>

      <!-- BOF Stage -->
      <section class="funnel-stage bof" data-stage="bof" aria-labelledby="bof-heading">
        <div class="stage-header">
          <div class="stage-titles">
            <h2 id="bof-heading">BOF</h2>
            <h3>Bottom of Funnel</h3>
            <div class="stage-count" aria-live="polite">0</div>
          </div>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress" id="bof-progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <span class="progress-text" id="bof-progress-text">0%</span>
          </div>
        </div>
        <div class="leads-container" id="bof-leads" role="region" aria-labelledby="bof-heading"></div>
        <button class="add-lead-btn" onclick="openAddLeadModal('bof')" aria-label="Add new lead to bottom of funnel">
          <i class="fas fa-plus" aria-hidden="true"></i> Add Lead
        </button>
      </section>
    </main>

    <!-- Analytics Panel -->
    <aside id="analyticsPanel" class="analytics-panel hidden" aria-labelledby="analytics-heading">
      <div class="analytics-header">
        <h3 id="analytics-heading"><i class="fas fa-chart-pie" aria-hidden="true"></i> Funnel Analytics</h3>
        <button class="close-btn" onclick="toggleAnalytics()" aria-label="Close analytics panel">
          <i class="fas fa-times" aria-hidden="true"></i>
        </button>
      </div>
      
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-value" id="totalLeads" aria-live="polite">0</div>
          <div class="metric-label">Total Leads</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="conversionRate" aria-live="polite">0%</div>
          <div class="metric-label">Conversion Rate</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="avgDwellTime" aria-live="polite">0d</div>
          <div class="metric-label">Avg. Dwell Time</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="forecastCompletions" aria-live="polite">0</div>
          <div class="metric-label">Forecast (7d)</div>
        </div>
      </div>
      
      <div class="timeline-section">
        <h4><i class="fas fa-history" aria-hidden="true"></i> Recent Activity</h4>
        <div class="timeline" id="activityTimeline" role="log" aria-live="polite"></div>
      </div>
    </aside>

    <!-- Add Lead Modal -->
    <div id="addLeadModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="addLeadModalTitle" hidden>
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal()" aria-label="Close modal">
          &times;
        </button>
        <h3 id="addLeadModalTitle">Add New Lead</h3>
        <form id="addLeadForm" onsubmit="return false;">
          <div class="form-group">
            <label for="leadName">Name *</label>
            <input type="text" id="leadName" placeholder="Company or person name" required>
          </div>
          <div class="form-group">
            <label for="leadTag">Tag</label>
            <select id="leadTag">
              <option value="">No tag</option>
              <option value="hot">üî• Hot lead</option>
              <option value="cold">‚ùÑÔ∏è Cold lead</option>
              <option value="repeat">üîÑ Repeat customer</option>
              <option value="vip">‚≠ê VIP</option>
            </select>
          </div>
          <div class="form-group">
            <label for="leadPriority">Priority</label>
            <select id="leadPriority">
              <option value="high">High</option>
              <option value="medium" selected>Medium</option>
              <option value="low">Low</option>
            </select>
          </div>
          <div class="form-group">
            <label for="leadNotes">Notes</label>
            <textarea id="leadNotes" placeholder="Add any notes..."></textarea>
          </div>
          <input type="hidden" id="currentStage">
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Lead</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Lead Modal -->
    <div id="editLeadModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editLeadModalTitle" hidden>
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal()" aria-label="Close modal">
          &times;
        </button>
        <h3 id="editLeadModalTitle">Edit Lead</h3>
        <div class="lead-info-header">
          <h4 id="editLeadName"></h4>
          <span class="lead-tag" id="editLeadTag"></span>
        </div>
        <form id="editLeadForm" onsubmit="return false;">
          <div class="form-group">
            <label for="editLeadStage">Stage</label>
            <select id="editLeadStage">
              <option value="tof">TOF - Top of Funnel</option>
              <option value="mof">MOF - Middle of Funnel</option>
              <option value="bof">BOF - Bottom of Funnel</option>
            </select>
          </div>
          <div class="form-group">
            <label for="editLeadPriority">Priority</label>
            <select id="editLeadPriority">
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
          </div>
          <div class="form-group">
            <label for="editLeadNotes">Notes</label>
            <textarea id="editLeadNotes" placeholder="Add any notes..."></textarea>
          </div>
          <input type="hidden" id="editingLeadId">
          <div class="form-actions">
            <button type="button" class="btn btn-danger" onclick="deleteLead()">Delete Lead</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" aria-live="assertive"></div>
  </div>

  <!-- JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
    integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  
  <script>
    // Initialize global namespace for PDF library
    window.jspdf = window.jspdf || { jsPDF: jsPDF };
    
    // Error handling for script loading
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = () => reject(new Error(`Script load error for ${src}`));
        document.head.appendChild(script);
      });
    }
    
    // Load main application script with error handling
    loadScript('script.js')
      .catch(error => {
        console.error('Failed to load application script:', error);
        document.getElementById('loadingIndicator').classList.add('hidden');
        document.getElementById('globalError').classList.remove('hidden');
      });
    
    // Service worker registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(registration => {
            console.log('ServiceWorker registration successful');
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
    
    // Global error handler
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      document.getElementById('globalError').classList.remove('hidden');
    });
    
    // Reload button handler
    document.getElementById('reloadButton')?.addEventListener('click', () => {
      window.location.reload();
    });
  </script>
</body>
</html>
